<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="yjk">
<cache eviction="LRU"  flushInterval="1800000"  size="4096" readOnly="true" />
	<!-- 违规增幅前三的关注点(违规数量) 如果是全国，regionId=10000 --><!-- 环比 -->
	<select id="getTop3errQtyWGZFList" resultType="Map"
		parameterType="Map">
		<if test="ctyIdStr == null or ctyIdStr == '' or ctyIdStr == '10000'">
			select top 3
			case when t2.concern_id=1001 then '未按规定在系统间同步加载' when
			t2.concern_id=1002 then '违规激活'
			when t2.concern_id=1003 then '违规销售'
			when t2.concern_id=1005 then '违规重复使用'
			when t2.concern_id=1004 then
			'退换后的坏卡或报废卡未封锁' else '其他' end as
			concern_name,
			sum(t2.errQty) as
			errQty,
			case when sum(t1.errQty)=0 then 0.00 else
			cast((sum(t2.errQty)*1.0000-sum(t1.errQty)*1.0000)/sum(t1.errQty)*100.00
			as decimal(16,2)) end as fbQtyPercent
			from
			hppdata.sum_yjk_prvdmap
			t1,hppdata.sum_yjk_prvdmap t2
			where
			t1.concern_id=t2.concern_id
			and
			t1.regionId=t2.regionId
			and t2.Aud_trm=#{audTrm} and
			t1.Aud_trm=#{lastAudTrm}
			<if test="prvdIdStr != '' and prvdIdStr !='10000' ">
				and t2.regionId in
				<foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			group by t2.concern_id
			order by
			abs(fbQtyPercent) desc
		</if>

		<if test="ctyIdStr != null and ctyIdStr != '' and ctyIdStr != '10000'">
			select top 3
			case when t2.concern_id=1001 then '未按规定在系统间同步加载' when
			t2.concern_id=1002 then '违规激活'
			when t2.concern_id=1003 then '违规销售'
			when t2.concern_id=1005 then '违规重复使用'
			when t2.concern_id=1004 then
			'退换后的坏卡或报废卡未封锁' else '其他' end as
			concern_name,
			sum(t2.errQty) as
			errQty,
			case when sum(t1.errQty)=0 then 0.00 else
			cast((sum(t2.errQty)*1.0000-sum(t1.errQty)*1.0000)/sum(t1.errQty)*100.00
			as decimal(16,2)) end as fbQtyPercent
			from
			hppdata.sum_yjk_ctymap
			t1,hppdata.sum_yjk_ctymap t2
			where
			t1.concern_id=t2.concern_id
			and
			t1.prvd_id = t2.prvd_id
			and t1.regionId=t2.regionId
			and
			t2.Aud_trm=#{audTrm} and
			t1.Aud_trm=#{lastAudTrm}
			and
			t2.prvd_id=#{prvdIds}
			and t2.regionId in
			<foreach item="item" index="index" collection="ctyIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
			group by t2.concern_id
			order by
			abs(fbQtyPercent)
			desc
		</if>
	</select>
	<!-- 违规增幅前三的关注点(违规数量占比) -->
	<select id="getTop3qtyPercentWGZFList" resultType="Map"
		parameterType="Map">

		<if test="ctyIdStr == null or ctyIdStr == '' or ctyIdStr == '10000'">
			select top 3
			case when t2.concern_id=1001 then '未按规定在系统间同步加载' when
			t2.concern_id=1002 then '违规激活'
			when t2.concern_id=1003 then '违规销售'
			when t2.concern_id=1005 then '违规重复使用'
			when t2.concern_id=1004 then
			'退换后的坏卡或报废卡未封锁' else '其他' end as
			concern_name,
			case when
			sum(t2.totalNum)=0 then 0.00 else
			cast(sum(t2.errQty)*1.0000/sum(t2.totalNum)*100.00 as decimal(16,2))
			end as qtyPercent,
			case when sum(t2.totalNum)=0 or sum(t1.totalNum)=0
			then 0.00 else
			cast(sum(t2.errQty)*1.0000/sum(t2.totalNum)*100.00-sum(t1.errQty)*1.0000/sum(t1.totalNum)*100.00
			as decimal(16,2)) end as qtyPP
			from
			hppdata.sum_yjk_prvdmap
			t1,hppdata.sum_yjk_prvdmap t2
			where t1.concern_id=t2.concern_id
			and
			t1.regionId=t2.regionId
			and t2.Aud_trm=#{audTrm} and
			t1.Aud_trm=#{lastAudTrm}
			<if test="prvdIdStr != '' and prvdIdStr !='10000' ">
				and t2.regionId in
				<foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			group by t2.concern_id
			order by
			abs(qtyPP)
			desc
		</if>
		<if test="ctyIdStr != null and ctyIdStr != '' and ctyIdStr != '10000'">
			select top 3
			case when t2.concern_id=1001 then '未按规定在系统间同步加载' when
			t2.concern_id=1002 then
			'违规激活'
			when t2.concern_id=1003 then '违规销售' when
			t2.concern_id=1005 then '违规重复使用'
			when t2.concern_id=1004 then
			'退换后的坏卡或报废卡未封锁' else '其他' end as
			concern_name,
			case when
			sum(t2.totalNum)=0 then 0.00 else
			cast(sum(t2.errQty)*1.0000/sum(t2.totalNum)*100.00 as decimal(16,2))
			end as qtyPercent,
			case when sum(t2.totalNum)=0 or sum(t1.totalNum)=0
			then 0.00 else
			cast(sum(t2.errQty)*1.0000/sum(t2.totalNum)*100.00-sum(t1.errQty)*1.0000/sum(t1.totalNum)*100.00
			as decimal(16,2)) end as qtyPP
			from
			hppdata.sum_yjk_ctymap
			t1,hppdata.sum_yjk_ctymap t2
			where t1.concern_id=t2.concern_id
			and
			t1.prvd_id = t2.prvd_id
			and t1.regionId=t2.regionId
			and
			t2.Aud_trm=#{audTrm} and
			t1.Aud_trm=#{lastAudTrm}
			and
			t2.prvd_id=#{prvdIds}
			and t2.regionId in
			<foreach item="item" index="index" collection="ctyIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
			group by t2.concern_id
			order by
			abs(qtyPP)
			desc
		</if>
	</select>
	<!-- 违规增幅前三的关注点(违规金额) -->
	<select id="getTop3errAmtWGZFList" resultType="Map"
		parameterType="Map">
		<if test="ctyIdStr == null or ctyIdStr == '' or ctyIdStr == '10000'">
			select top 3
			case when t2.concern_id=1001 then '未按规定在系统间同步加载' when
			t2.concern_id=1002
			then '违规激活'
			when t2.concern_id=1003 then '违规销售' when
			t2.concern_id=1005 then '违规重复使用'
			when t2.concern_id=1004 then
			'退换后的坏卡或报废卡未封锁' else '其他' end as
			concern_name,
			sum(t2.errAmt) as
			errAmt,
			case when sum(t1.errAmt)=0 then 0.00 else
			cast((sum(t2.errAmt)*1.0000-sum(t1.errAmt)*1.0000)/sum(t1.errAmt)*100.00
			as decimal(16,2)) end as
			fbAmtPercent
			from
			hppdata.sum_yjk_prvdmap
			t1,hppdata.sum_yjk_prvdmap t2
			where
			t1.concern_id=t2.concern_id
			and
			t1.regionId=t2.regionId
			and t2.Aud_trm=#{audTrm} and
			t1.Aud_trm=#{lastAudTrm}
			<if test="prvdIdStr != '' and prvdIdStr !='10000' ">
				and t2.regionId in
				<foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			group by t2.concern_id
			order by
			abs(fbAmtPercent)
			desc
		</if>
		<if test="ctyIdStr != null and ctyIdStr != '' and ctyIdStr != '10000'">
			select top 3
			case when t2.concern_id=1001 then '未按规定在系统间同步加载' when
			t2.concern_id=1002
			then '违规激活'
			when t2.concern_id=1003 then '违规销售' when
			t2.concern_id=1005 then '违规重复使用'
			when t2.concern_id=1004 then
			'退换后的坏卡或报废卡未封锁' else '其他' end as
			concern_name,
			sum(t2.errAmt) as
			errAmt,
			case when sum(t1.errAmt)=0 then
			0.00 else
			cast((sum(t2.errAmt)*1.0000-sum(t1.errAmt)*1.0000)/sum(t1.errAmt)*100.00
			as decimal(16,2)) end as
			fbAmtPercent
			from
			hppdata.sum_yjk_ctymap
			t1,hppdata.sum_yjk_ctymap t2
			where
			t1.concern_id=t2.concern_id
			and
			t1.prvd_id=t2.prvd_id
			and t1.regionId=t2.regionId
			and
			t2.Aud_trm=#{audTrm} and
			t1.Aud_trm=#{lastAudTrm}
			and
			t2.prvd_id=#{prvdIds}
			and t2.regionId in
			<foreach item="item" index="index" collection="ctyIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
			group by t2.concern_id
			order by
			abs(fbAmtPercent)
			desc
		</if>
	</select>
	<!-- 违规增幅前三的关注点(违规金额占比) -->
	<select id="getTop3errPercentWGZFList" resultType="Map"
		parameterType="Map">
		<if test="ctyIdStr == null or ctyIdStr == '' or ctyIdStr == '10000'">
			select top 3
			case when t2.concern_id=1001 then '未按规定在系统间同步加载' when
			t2.concern_id=1002 then '违规激活'
			when t2.concern_id=1003 then '违规销售'
			when t2.concern_id=1005 then '违规重复使用'
			when t2.concern_id=1004 then
			'退换后的坏卡或报废卡未封锁' else '其他' end as
			concern_name,
			case when
			sum(t2.tolAmt)=0 then 0.00 else
			cast((sum(t2.errAmt)*1.0000/sum(t2.tolAmt)*100.00) as decimal(16,2))
			end as amtPercent,
			case when sum(t2.tolAmt)=0 or sum(t1.tolAmt)=0 then
			0.00 else
			cast((sum(t2.errAmt)*1.0000/sum(t2.tolAmt)*100.00) as
			decimal(16,2))-cast((sum(t1.errAmt)*1.0000/sum(t1.tolAmt)*100.00) as
			decimal(16,2)) end as amtPP
			from
			hppdata.sum_yjk_prvdmap
			t1,hppdata.sum_yjk_prvdmap t2
			where
			t1.concern_id=t2.concern_id
			and
			t1.regionId=t2.regionId
			and t2.Aud_trm=#{audTrm} and
			t1.Aud_trm=#{lastAudTrm}
			<if test="prvdIdStr != '' and prvdIdStr !='10000' ">
				and t2.regionId in
				<foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			group by t2.concern_id
			order by
			abs(amtPP)
			desc
		</if>

		<if test="ctyIdStr != null and ctyIdStr != '' and ctyIdStr != '10000'">
			select top 3
			case when t2.concern_id=1001 then '未按规定在系统间同步加载' when
			t2.concern_id=1002 then '违规激活'
			when t2.concern_id=1003 then '违规销售'
			when t2.concern_id=1005 then '违规重复使用'
			when t2.concern_id=1004 then
			'退换后的坏卡或报废卡未封锁' else '其他' end as
			concern_name,
			case when
			sum(t2.tolAmt)=0 then 0.00 else
			cast((sum(t2.errAmt)*1.0000/sum(t2.tolAmt)*100.00) as decimal(16,2))
			end as amtPercent,
			case when sum(t2.tolAmt)=0 or sum(t1.tolAmt)=0 then
			0.00 else
			cast((sum(t2.errAmt)*1.0000/sum(t2.tolAmt)*100.00) as
			decimal(16,2))-cast((sum(t1.errAmt)*1.0000/sum(t1.tolAmt)*100.00) as
			decimal(16,2)) end as amtPP
			from
			hppdata.sum_yjk_ctymap
			t1,hppdata.sum_yjk_ctymap t2
			where
			t1.concern_id=t2.concern_id
			and
			t1.prvd_id = t2.prvd_id
			and t1.regionId=t2.regionId
			and
			t2.Aud_trm=#{audTrm} and
			t1.Aud_trm=#{lastAudTrm}
			and
			t2.prvd_id=#{prvdIds}
			and t2.regionId in
			<foreach item="item" index="index" collection="ctyIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
			group by t2.concern_id
			order by
			abs(amtPP)
			desc
		</if>
	</select>
	<!--关注事项违规值最多  6个有价卡类型-->
	<select id="getInfracList" resultType="Map" parameterType="Map">
	<if test=" key =='errQty' ">
		<if test="ctyIdStr == null or ctyIdStr == '' or ctyIdStr == '10000'">
		select t2.infraction_typ, t2.infraction_typ_name, sum(t2.infraction_num) as infraction_num2, 
		(sum(t2.infraction_num)-sum(t1.infraction_num))as infraction_zf
		 from hppdata.sum_yjk_1000_prvd_infrac t1,hppdata.sum_yjk_1000_prvd_infrac t2
		  where	t1.infraction_typ = t2.infraction_typ
		  and t1.yjk_typ=t2.yjk_typ
				and t1.prvd_id = t2.prvd_id
				and t2.Aud_trm=#{audTrm} 
				and	t1.Aud_trm=#{lastAudTrm}
				and t2.infraction_typ like '${focusCd}'
				<if test="prvdIdStr != '' and prvdIdStr !='10000' ">
					and t2.prvd_id in
					<foreach item="item" index="index" collection="prvdIds"
						open="(" separator="," close=")">
						#{item}
					</foreach>
				</if>
			group by t2.infraction_typ,t2.infraction_typ_name
		</if>
		<if test="ctyIdStr != null and ctyIdStr != '' and ctyIdStr != '10000'">
		select t2.infraction_typ, t2.infraction_typ_name, sum(t2.infraction_num) as infraction_num2, 
		(sum(t2.infraction_num)-sum(t1.infraction_num))as infraction_zf
		 from hppdata.sum_yjk_1000_prvd_infrac t1,hppdata.sum_yjk_1000_prvd_infrac t2
		  where	t1.infraction_typ = t2.infraction_typ
		  		and t1.yjk_typ=t2.yjk_typ
				and t1.prvd_id = t2.prvd_id
				and t2.Aud_trm=#{audTrm} 
				and	t1.Aud_trm=#{lastAudTrm}
				and t2.infraction_typ like '${focusCd}'
				and t2.prvd_id=#{prvdIds}
			and t1.cty_id = t2.cty_id
			and t2.cty_id in
			<foreach item="item" index="index" collection="ctyIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
			group by t2.infraction_typ,t2.infraction_typ_name
		</if>
	</if>
	<if test=" key =='errAmt' ">
	<if test="ctyIdStr == null or ctyIdStr == '' or ctyIdStr == '10000'">
	select t2.infraction_typ, t2.infraction_typ_name, sum(t2.infraction_amt) as infraction_num2, 
	(sum(t2.infraction_amt)-sum(t1.infraction_amt))as infraction_zf
	 from hppdata.sum_yjk_1000_prvd_infrac t1,hppdata.sum_yjk_1000_prvd_infrac t2
	  where	t1.infraction_typ = t2.infraction_typ
	  and t1.yjk_typ=t2.yjk_typ
			and t1.prvd_id = t2.prvd_id
			and t2.Aud_trm=#{audTrm} 
			and	t1.Aud_trm=#{lastAudTrm}
			and t2.infraction_typ like '${focusCd}'
			<if test="prvdIdStr != '' and prvdIdStr !='10000' ">
				and t2.prvd_id in
				<foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		group by t2.infraction_typ,t2.infraction_typ_name
		</if>
		<if test="ctyIdStr != null and ctyIdStr != '' and ctyIdStr != '10000'">
			select t2.infraction_typ, t2.infraction_typ_name, sum(t2.infraction_amt) as infraction_num2, 
			(sum(t2.infraction_amt)-sum(t1.infraction_amt))as infraction_zf
			 from hppdata.sum_yjk_1000_new_infrac t1,hppdata.sum_yjk_1000_new_infrac t2
			  where	t1.infraction_typ = t2.infraction_typ
			  and t1.yjk_typ=t2.yjk_typ
			and t1.prvd_id = t2.prvd_id
			and t2.Aud_trm=#{audTrm} 
			and	t1.Aud_trm=#{lastAudTrm}
			and t2.infraction_typ like '${focusCd}'
			and t2.prvd_id=#{prvdIds}
			and t1.cty_id = t2.cty_id
			and t2.cty_id in
			<foreach item="item" index="index" collection="ctyIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
		group by t2.infraction_typ,t2.infraction_typ_name
		</if>
	</if>
	<if test=" key =='qtyPercent' ">
		<if test="ctyIdStr == null or ctyIdStr == '' or ctyIdStr == '10000'">
		select t2.infraction_typ, t2.infraction_typ_name, 
	    sum(t2.tol_num) as tol_num2,
	    sum(t1.tol_num) as tol_num1,
		case when tol_num2=0 then 0.00 else cast(sum(t2.infraction_num)*1.0000/tol_num2*100.00 as decimal(16,2)) end as infraction_num2,
		case when tol_num1=0 then 0.00 else cast(sum(t1.infraction_num)*1.0000/tol_num1*100.00 as decimal(16,2)) end as infraction_num1,
		(infraction_num2-infraction_num1) as infraction_zf
		 from hppdata.sum_yjk_1000_prvd_infrac t1,hppdata.sum_yjk_1000_prvd_infrac t2
		  where	t1.infraction_typ = t2.infraction_typ
		  and t1.yjk_typ=t2.yjk_typ
				and t1.prvd_id = t2.prvd_id
				and t2.Aud_trm=#{audTrm} 
				and	t1.Aud_trm=#{lastAudTrm}
				and t2.infraction_typ like '${focusCd}'
				<if test="prvdIdStr != '' and prvdIdStr !='10000' ">
					and t2.prvd_id in
					<foreach item="item" index="index" collection="prvdIds"
						open="(" separator="," close=")">
						#{item}
					</foreach>
				</if>
			group by t2.infraction_typ,t2.infraction_typ_name
			</if>
			<if test="ctyIdStr != null and ctyIdStr != '' and ctyIdStr != '10000'">
			select t2.infraction_typ, t2.infraction_typ_name, 
	    sum(t2.tol_num) as tol_num2,
	    sum(t1.tol_num) as tol_num1,
		case when tol_num2=0 then 0.00 else cast(sum(t2.infraction_num)*1.0000/tol_num2*100.00 as decimal(16,2)) end as infraction_num2,
		case when tol_num1=0 then 0.00 else cast(sum(t1.infraction_num)*1.0000/tol_num1*100.00 as decimal(16,2)) end as infraction_num1,
		(infraction_num2-infraction_num1) as infraction_zf
		 from hppdata.sum_yjk_1000_new_infrac t1,hppdata.sum_yjk_1000_new_infrac t2
		  where	t1.infraction_typ = t2.infraction_typ
		 		and t1.yjk_typ=t2.yjk_typ
				and t1.prvd_id = t2.prvd_id
				and t2.Aud_trm=#{audTrm} 
				and	t1.Aud_trm=#{lastAudTrm}
				and t2.infraction_typ like '${focusCd}'
				and t2.prvd_id=#{prvdIds}
				and t1.cty_id = t2.cty_id
				and t2.cty_id in
			<foreach item="item" index="index" collection="ctyIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
			group by t2.infraction_typ,t2.infraction_typ_name
			</if>
	</if>
	<if test=" key =='errPercent' ">
	<if test="ctyIdStr == null or ctyIdStr == '' or ctyIdStr == '10000'">
	select t2.infraction_typ, t2.infraction_typ_name, 
    sum(t2.tol_amt) as tol_num2,
    sum(t1.tol_amt) as tol_num1,
	case when tol_num2=0 then 0.00 else cast(sum(t2.infraction_amt)*1.0000/tol_num2*100.00 as decimal(16,2)) end as infraction_num2,
	case when tol_num1=0 then 0.00 else cast(sum(t1.infraction_amt)*1.0000/tol_num1*100.00 as decimal(16,2)) end as infraction_num1,
	(infraction_num2-infraction_num1) as infraction_zf
	 from hppdata.sum_yjk_1000_prvd_infrac t1,hppdata.sum_yjk_1000_prvd_infrac t2
	  where	t1.infraction_typ = t2.infraction_typ
	  and t1.yjk_typ=t2.yjk_typ
			and t1.prvd_id = t2.prvd_id
			and t2.Aud_trm=#{audTrm} 
			and	t1.Aud_trm=#{lastAudTrm}
			and t2.infraction_typ like '${focusCd}'
			<if test="prvdIdStr != '' and prvdIdStr !='10000' ">
				and t2.prvd_id in
				<foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		group by t2.infraction_typ,t2.infraction_typ_name
		</if>
		<if test="ctyIdStr != null and ctyIdStr != '' and ctyIdStr != '10000'">
			select t2.infraction_typ, t2.infraction_typ_name, 
    sum(t2.tol_amt) as tol_num2,
    sum(t1.tol_amt) as tol_num1,
	case when tol_num2=0 then 0.00 else cast(sum(t2.infraction_amt)*1.0000/tol_num2*100.00 as decimal(16,2)) end as infraction_num2,
	case when tol_num1=0 then 0.00 else cast(sum(t1.infraction_amt)*1.0000/tol_num1*100.00 as decimal(16,2)) end as infraction_num1,
	(infraction_num2-infraction_num1) as infraction_zf
	 from hppdata.sum_yjk_1000_new_infrac t1,hppdata.sum_yjk_1000_new_infrac t2
	  where	t1.infraction_typ = t2.infraction_typ
	  and t1.yjk_typ=t2.yjk_typ
			and t1.prvd_id = t2.prvd_id
			and t1.cty_id = t2.cty_id
			and t2.Aud_trm=#{audTrm} 
			and	t1.Aud_trm=#{lastAudTrm}
			and t2.infraction_typ like '${focusCd}'
			and t2.prvd_id=#{prvdIds}
			and t2.cty_id in
			<foreach item="item" index="index" collection="ctyIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
		group by t2.infraction_typ,t2.infraction_typ_name
		</if>
	</if>
	</select>
	<!-- 有价卡地图省份显示 -->
	<select id="getYjkChinaMap" resultType="Map" parameterType="Map">
		<if test="attrName != '' and attrName =='errQty' ">
			select
			t.regionId,
			t.errQty,
			t.qtyPercent,
			t.errAmt,
			t.errPercent,row_number() over(order by t.errQty desc) as valRank
			from hppdata.Sum_yjk_prvdmap t
			where t.aud_trm=#{audTrm}
			<if test="prvdIdStr != '' and prvdIdStr !=null and prvdIdStr!='10000' ">
				and t.regionId in
				<foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			and t.concern_id in
			<foreach item="item" index="index" collection="focusCds"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="attrName != '' and attrName =='errAmt' ">
			select
			t.regionId,
			t.errQty,
			t.qtyPercent,
			t.errAmt,
			t.errPercent,row_number() over(order by t.errAmt desc) as valRank
			from hppdata.Sum_yjk_prvdmap t
			where t.aud_trm=#{audTrm}
			<if test="prvdIdStr != '' and prvdIdStr !=null and prvdIdStr!='10000' ">
				and t.regionId in
				<foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			and t.concern_id in
			<foreach item="item" index="index" collection="focusCds"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="attrName != '' and attrName =='qtyPercent' ">
			select
			t.regionId,
			t.errQty,
			t.qtyPercent,
			t.errAmt,
			t.errPercent,row_number() over(order by t.qtyPercent desc,t.errQty desc) as valRank
			from hppdata.Sum_yjk_prvdmap
			t where t.aud_trm=#{audTrm}
			<if test="prvdIdStr != '' and prvdIdStr !=null and prvdIdStr!='10000' ">
				and t.regionId in
				<foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			and t.concern_id in
			<foreach item="item" index="index" collection="focusCds"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="attrName != '' and attrName =='errPercent' ">
			select
			t.regionId,
			t.errQty,
			t.qtyPercent,
			t.errAmt,
			t.errPercent,row_number() over(order by t.errPercent desc,t.errQty desc) as valRank
			from hppdata.Sum_yjk_prvdmap
			t where t.aud_trm=#{audTrm}
			<if test="prvdIdStr != '' and prvdIdStr !=null and prvdIdStr!='10000' ">
				and t.regionId in
				<foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			and t.concern_id in
			<foreach item="item" index="index" collection="focusCds"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
	</select>
	<!-- 有价卡地图地市显示 -->
	<select id="getYjkProvMap" resultType="Map" parameterType="Map">
		<if test="attrName != '' and attrName =='errQty' ">
			select
			t.regionId,
			t.errQty,
			t.qtyPercent,
			t.errAmt,
			t.errPercent,row_number() over(order by t.errQty desc) as valRank
			from hppdata.Sum_yjk_ctymap t
			where t.aud_trm=#{audTrm}
			and t.prvd_id in
			<foreach item="item" index="index" collection="prvdIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
			<if test="ctyIdStr != null and ctyIdStr != ''  and ctyIdStr!='10000' ">
				and t.regionId in
				<foreach item="item" index="index" collection="ctyIds" open="("
					separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="ctyIdStr=='10000' ">
			 AND regionId not in (0)
			 </if>
			and t.concern_id in
			<foreach item="item" index="index" collection="focusCds"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="attrName != '' and attrName =='errAmt' ">
			select
			t.regionId,
			t.errQty,
			t.qtyPercent,
			t.errAmt,
			t.errPercent,row_number() over(order by t.errAmt desc) as valRank
			from hppdata.Sum_yjk_ctymap t
			where t.aud_trm=#{audTrm}
			and t.prvd_id in
			<foreach item="item" index="index" collection="prvdIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
			<if test="ctyIdStr != null and ctyIdStr != ''  and ctyIdStr!='10000' ">
				and t.regionId in
				<foreach item="item" index="index" collection="ctyIds" open="("
					separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="ctyIdStr=='10000' ">
			 AND regionId not in (0)
			 </if>
			and t.concern_id in
			<foreach item="item" index="index" collection="focusCds"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="attrName != '' and attrName =='qtyPercent' ">
			select
			t.regionId,
			t.errQty,
			t.qtyPercent,
			t.errAmt,
			t.errPercent,row_number() over(order by t.qtyPercent desc,t.errQty desc) as valRank
			from hppdata.Sum_yjk_ctymap t
			where t.aud_trm=#{audTrm}
			and t.prvd_id in
			<foreach item="item" index="index" collection="prvdIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
			<if test="ctyIdStr != null and ctyIdStr != ''  and ctyIdStr!='10000' ">
				and t.regionId in
				<foreach item="item" index="index" collection="ctyIds" open="("
					separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="ctyIdStr=='10000' ">
			 AND regionId not in (0)
			 </if>
			and t.concern_id in
			<foreach item="item" index="index" collection="focusCds"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="attrName != '' and attrName =='errPercent' ">
			select
			t.regionId,
			t.errQty,
			t.qtyPercent,
			t.errAmt,
			t.errPercent,row_number() over(order by t.errPercent desc,t.errAmt desc) as valRank
			from hppdata.Sum_yjk_ctymap t
			where t.aud_trm=#{audTrm}
			and t.prvd_id in
			<foreach item="item" index="index" collection="prvdIds" open="("
				separator="," close=")">
				#{item}
			</foreach>
			<if test="ctyIdStr != null and ctyIdStr != ''  and ctyIdStr!='10000' ">
				and t.regionId in
				<foreach item="item" index="index" collection="ctyIds" open="("
					separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="ctyIdStr=='10000' ">
			 AND regionId not in (0)
			 </if>
			and t.concern_id in
			<foreach item="item" index="index" collection="focusCds"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
	</select>
	
<!-- 用于查询有价卡主界面左边的四个数据 -->
	<select id="getSummaryData" resultType="Map" parameterType="Map">	
	<if test="ctyIdStr == null or ctyIdStr =='' ">
		SELECT 
		aud_trm as audTrm, 
			sum(errQty) as errQty, sum(totalNum) as totalNum, case when sum(totalNum) =0 then 0.00 else cast((sum(errQty) *1.0000/sum(totalNum)*100.00) as decimal(16,2)) end as qtyPercent,
			sum(errAmt) as errAmt, sum(tolAmt) as tolAmt, case when sum(tolAmt) =0 then 0.00 else cast((sum(errAmt) *1.0000/sum(tolAmt)*100.00) as decimal(16,2)) end as errPercent
		FROM hppdata.sum_yjk_prvdmap
		WHERE 1=1
		AND concern_id ='${concernIdStr}'
		<if test="regionIdStr!='10000' ">
		AND regionId IN (${regionIdStr})
		</if>
		AND aud_trm IN (${audTrms})
		GROUP BY aud_trm
	</if>
	<if test="ctyIdStr != null and ctyIdStr !='' ">	
	SELECT 
		aud_trm as audTrm, 
			sum(errQty) as errQty, sum(totalNum) as totalNum, case when sum(totalNum) =0 then 0.00 else cast((sum(errQty) *1.0000/sum(totalNum)*100.00) as decimal(16,2)) end as qtyPercent,
			sum(errAmt) as errAmt, sum(tolAmt) as tolAmt, case when sum(tolAmt) =0 then 0.00 else cast((sum(errAmt) *1.0000/sum(tolAmt)*100.00) as decimal(16,2)) end as errPercent
		FROM hppdata.sum_yjk_ctymap
		WHERE 1=1
		AND concern_id ='${concernIdStr}'
		AND regionId IN (${ctyIdStr})
		AND aud_trm IN (${audTrms})
		GROUP BY aud_trm
	</if>
	</select>
	<!-- 用于查询有价卡主界面右下的地区横向对比图地区排序   （所选关注点简单累加查）-->
	 <select id="getSumFoucAreaData" resultType="Map" parameterType="Map">
		<if test="ctyIdStr == null">
			<!-- 集团用户未选择任何省，默认全公司时，查出所有省，并显示无数据省 -->
				select 
					prvCon.short_name as regionName, 
					prvCon.prvd_id as regionId, 
	
					coalesce(t.errQty1,0) as errQty1, 
					coalesce(t.qtyPercent1,0) as qtyPercent1, 
					
					coalesce(t.errAmt1,0) as errAmt1, 
					coalesce(t.errPercent1,0) as errPercent1
				from 
				(select * from HPMGR.busi_workspace_org 
				<if test="prvdIdStr != '10000'">
				where prvd_id IN (${prvdIdStr})
				</if>
				<if test="prvdIdStr == '10000'">
				where prvd_id not IN (${prvdIdStr})
				</if>
				) prvCon left join
				(
			SELECT regionId,regionName,
				sum(errQty) as errQty1 ,sum(qtyPercent) as qtyPercent1,
				sum(errAmt) as errAmt1, sum(errPercent) as errPercent1
			FROM hppdata.sum_yjk_prvdmap
			WHERE concern_id in (${concernIdStr})
			AND aud_trm =${audTrm}
			<if test="prvdIdStr != '10000'">
				AND regionId IN (${prvdIdStr})
			</if>
			GROUP BY regionId,regionName
			)t
			on t.regionId = prvCon.prvd_id
			
			<if test="attrName == 'qtyPercent'">
			ORDER BY qtyPercent1 desc
			</if>
			<if test="attrName == 'errQty'">
			ORDER BY errQty1 desc
			</if>
			<if test="attrName == 'errPercent'">
			ORDER BY errPercent1 desc
			</if>
			<if test="attrName == 'errAmt'">
			ORDER BY errAmt1 desc
			</if>
		</if>
		<if test="ctyIdStr != null">
			select 
				ctyCon.cmcc_prvd_nm_short as regionName, 
				ctyCon.cmcc_prvd_cd as regionId, 
				
				coalesce(t.errQty1,0) as errQty1, 
				coalesce(t.qtyPercent1,0) as qtyPercent1, 
				
				coalesce(t.errAmt1,0) as errAmt1, 
				coalesce(t.errPercent1,0) as errPercent1
			from 
			(select * from hpmgr.TB_SUM_PRVD_NAME
			<if test="ctyIdStr == ''">
					where cmcc_prov_prvd_id=${prvdIdStr} AND cmcc_prvd_cd not in (0)
			</if>
			<if test="ctyIdStr != ''">
					where cmcc_prvd_cd IN (${ctyIdStr})
			</if>
			) ctyCon left join
			(
				SELECT regionId,regionName,
					sum(errQty) as errQty1 ,sum(qtyPercent) as qtyPercent1,
					sum(errAmt) as errAmt1, sum(errPercent) as errPercent1
					FROM hppdata.sum_yjk_ctymap
				WHERE
				concern_id in (${concernIdStr})
				<if test="ctyIdStr == ''">
						AND prvd_id=${prvdIdStr} AND regionId not in (0)
				</if>
				<if test="ctyIdStr != ''">
						AND regionId IN (${ctyIdStr})
				</if>
				AND aud_trm = ${audTrm}
				GROUP BY regionId,regionName
			)t 
			on t.regionId=ctyCon.cmcc_prvd_cd 
			<if test="attrName == 'qtyPercent'">
				ORDER BY qtyPercent1 desc
			</if>
			<if test="attrName == 'errQty'">
				ORDER BY errQty1 desc
			</if>
			<if test="attrName == 'errPercent'">
				ORDER BY errPercent1 desc
			</if>
			<if test="attrName == 'errAmt'">
				ORDER BY errAmt1 desc
			</if>
		</if>
	</select>
	
<!-- 用于查询有价卡主界面右下的地区横向对比图  （每个关注点分开查）-->	
	<select id="getAreaData" resultType="Map" parameterType="Map">
		<if test="ctyIdStr == null">
		<!-- 集团用户未选择任何省，默认全公司时，查出所有省，并显示无数据省 -->
			select 
				prvCon.short_name as regionName, 
				prvCon.prvd_id as regionId, 
				
				coalesce(t.concernId,'') as concernId,

				coalesce(t.errQty,0) as errQty, 
				coalesce(t.totalNum,0) as totalNum, 
				coalesce(t.qtyPercent,0) as qtyPercent, 
				
				coalesce(t.errAmt,0) as errAmt, 
				coalesce(t.tolAmt,0) as tolAmt, 
				coalesce(t.errPercent,0) as errPercent
			from
			(select * from  HPMGR.busi_workspace_org
			<if test="prvdIdStr != '10000'">
			where prvd_id IN (${prvdIdStr})
		</if>
		<if test="prvdIdStr == '10000'">
			where prvd_id not IN (${prvdIdStr})
		</if>
			)  prvCon left join
			(
		SELECT regionId,concern_id as concernId,
			sum(errQty) as errQty, 
			sum(totalNum) as totalNum, 
			case when sum(totalNum) =0 then 0.00 else cast((sum(errQty) *1.0000/sum(totalNum)*100.00) as decimal(16,2)) end as qtyPercent,
			sum(errAmt) as errAmt, 
			sum(tolAmt) as tolAmt, 
			case when sum(tolAmt) =0 then 0.00 else cast((sum(errAmt) *1.0000/sum(tolAmt)*100.00) as decimal(16,2)) end as errPercent 
		FROM hppdata.sum_yjk_prvdmap
		WHERE 1=1
		AND concern_id IN (${concernIdStr})
		<if test="prvdIdStr != '10000'">
			AND regionId IN (${prvdIdStr})
		</if>
		AND aud_trm =${audTrm}
		GROUP BY regionId,concern_id
		) t
		on t.regionId = prvCon.prvd_id
		
			ORDER BY t.concernId desc
		</if>
		<if test="ctyIdStr != null">
		<!-- 省用户未选择任何地市，默认全省时，查出所有地市 -->
			select 
				ctyCon.cmcc_prvd_nm_short as regionName, 
				ctyCon.cmcc_prvd_cd as regionId, 
				t.concernId as concernId,
				
				coalesce(t.errQty,0) as errQty, 
				coalesce(t.totalNum,0) as totalNum, 
				coalesce(t.qtyPercent,0) as qtyPercent, 
				
				coalesce(t.errAmt,0) as errAmt, 
				coalesce(t.tolAmt,0) as tolAmt, 
				coalesce(t.errPercent,0) as errPercent
			from
			(select * from  hpmgr.TB_SUM_PRVD_NAME
			<if test="ctyIdStr == ''">
				where cmcc_prov_prvd_id=${prvdIdStr} AND cmcc_prvd_cd not in (0)
		</if>
		<if test="ctyIdStr != ''">
				where cmcc_prvd_cd IN (${ctyIdStr})
		</if>
			) ctyCon left join
			(
		SELECT regionId,concern_id as concernId,
			sum(errQty) as errQty, sum(totalNum) as totalNum, case when sum(totalNum) =0 then 0.00 else cast((sum(errQty) *1.0000/sum(totalNum)*100.00) as decimal(16,2)) end as qtyPercent,
			sum(errAmt) as errAmt, sum(tolAmt) as tolAmt, case when sum(tolAmt) =0 then 0.00 else cast((sum(errAmt) *1.0000/sum(tolAmt)*100.00) as decimal(16,2)) end as errPercent 
		FROM hppdata.sum_yjk_ctymap
		WHERE 1=1
		AND concern_id IN (${concernIdStr})
		<if test="ctyIdStr == ''">
				AND prvd_id=${prvdIdStr} AND regionId not in (0)
		</if>
		<if test="ctyIdStr != ''">
				AND regionId IN (${ctyIdStr})
		</if>
		AND aud_trm =${audTrm}
		GROUP BY regionId,concern_id
		) t
		on t.regionId = ctyCon.cmcc_prvd_cd
			
		ORDER BY t.concernId desc
		</if>
	</select>
	
<!-- 用于查询有价卡主界面右下的地区趋势对比图 -->	
	<select id="getAreaMonthlyData" resultType="Map" parameterType="Map">
	<if test="ctyIdStr == null or ctyIdStr == ''">
		SELECT aud_trm as audTrm,
			sum(errQty) as errQty, sum(totalNum) as totalNum, case when sum(totalNum) =0 then 0.00 else cast((sum(errQty) *1.0000/sum(totalNum)*100.00) as decimal(16,2)) end as qtyPercent,
			sum(errAmt) as errAmt, sum(tolAmt) as tolAmt, case when sum(tolAmt) =0 then 0.00 else cast((sum(errAmt) *1.0000/sum(tolAmt)*100.00) as decimal(16,2)) end as errPercent 
		FROM hppdata.sum_yjk_prvdmap
		WHERE concern_id ='${concernIdStr}'
		<if test="prvdIdStr != '10000'">
		AND regionId IN (${prvdIdStr})
		</if>
	<![CDATA[
		AND aud_trm <=${audTrmEnd}
		AND aud_trm >=${audTrmStart} 
	]]>
		GROUP BY aud_trm
		ORDER BY aud_trm
	</if>
	<if test="ctyIdStr != null and ctyIdStr != ''">
		SELECT aud_trm as audTrm,
			sum(errQty) as errQty, sum(totalNum) as totalNum, case when sum(totalNum) =0 then 0.00 else cast((sum(errQty) *1.0000/sum(totalNum)*100.00) as decimal(16,2)) end as qtyPercent,
			sum(errAmt) as errAmt, sum(tolAmt) as tolAmt, case when sum(tolAmt) =0 then 0.00 else cast((sum(errAmt) *1.0000/sum(tolAmt)*100.00) as decimal(16,2)) end as errPercent 
		FROM hppdata.sum_yjk_ctymap
		WHERE concern_id ='${concernIdStr}'
		AND regionId IN (${ctyIdStr})
	<![CDATA[
		AND aud_trm <=${audTrmEnd}
		AND aud_trm >=${audTrmStart} 
	]]>
		GROUP BY aud_trm
		ORDER BY aud_trm
	</if>
	</select>
	
	<select id="getProvDetailData" resultType="Map" parameterType="Map">
		SELECT	 
		
 	    <if test="orderField=='errQtydesc'"> 	    	
			 row_number()over(order by errQty desc) as RN,			 
		</if>
	    <if test="orderField=='errQtyasc'"> 	    	
			 row_number()over(order by errQty asc) as RN,			 
		</if>
		<if test="orderField=='qtyPercentdesc'">
			 row_number()over(order by qtyPercent desc, errQty desc) as RN,
		</if>
		<if test="orderField=='qtyPercentasc'">
			 row_number()over(order by qtyPercent asc, by errQty asc) as RN,
		</if>		
		<if test="orderField=='errAmtdesc'">
			 row_number()over(order by errAmt desc) as RN,	 
		</if>
		<if test="orderField=='errAmtasc'">
			 row_number()over(order by errAmt asc) as RN,	 
		</if>		
		<if test="orderField=='errPercentdesc'">
			 row_number()over(order by errPercent desc, errAmt desc) as RN,		 
		</if>
		<if test="orderField=='errPercentasc'">
			 row_number()over(order by errPercent asc, errAmt asc) as RN,		 
		</if>
			regionId as prvdId,concern_id as concernId, regionName as regionName, coalesce(cntArea,0) as cntArea,
			errQty as errQty, totalNum as totalNum,qtyPercent as qtyPercent, qtyPercent(FORMAT 'ZZ9.99%')(VARCHAR(7)) as qtyPercent_formatter,
			errAmt as errAmt, tolAmt as tolAmt,errPercent as errPercent, errPercent(FORMAT 'ZZ9.99%')(VARCHAR(7))  as errPercent_formatter 
		FROM hppdata.sum_yjk_prvdmap
		WHERE
		 concern_id ='${concernIdStr}'
		AND aud_trm = ${audTrm}
		<if test="regionIdStr!='10000' ">
			AND regionId IN (${regionIdStr})
   	    </if>
   	    <!-- <![CDATA[
		AND errQty <>0 AND errAmt <>0 
		]]> -->
 		order by RN
	</select>
	
	<select id="getCityDetailData" resultType="Map" parameterType="Map">
		SELECT
 	    <if test="orderField=='errQtydesc'"> 	    	
			 row_number()over(order by errQty desc) as RN,			 
		</if>
	    <if test="orderField=='errQtyasc'"> 	    	
			 row_number()over(order by errQty asc) as RN,			 
		</if>
		<if test="orderField=='qtyPercentdesc'">
			 row_number()over(order by qtyPercent desc, errQty desc) as RN,
		</if>
		<if test="orderField=='qtyPercentasc'">
			 row_number()over(order by qtyPercent asc, errQty asc) as RN,
		</if>		
		<if test="orderField=='errAmtdesc'">
			 row_number()over(order by errAmt desc) as RN,	 
		</if>
		<if test="orderField=='errAmtasc'">
			 row_number()over(order by errAmt asc) as RN,	 
		</if>		
		<if test="orderField=='errPercentdesc'">
			 row_number()over(order by errPercent desc, errAmt desc) as RN,		 
		</if>
		<if test="orderField=='errPercentasc'">
			 row_number()over(order by errPercent asc, errAmt asc) as RN,		 
		</if>	 
			regionId,concern_id as concernId,prvdName as prvdName, case when regionId=0 then 'VC无归属地市' else regionName end as regionName,
			errQty as errQty, totalNum as totalNum,qtyPercent as qtyPercent, qtyPercent(FORMAT 'ZZ9.99%')(VARCHAR(7)) as qtyPercent_formatter,
			errAmt as errAmt, tolAmt as tolAmt,errPercent as errPercent, errPercent(FORMAT 'ZZ9.99%')(VARCHAR(7))  as errPercent_formatter 
		FROM hppdata.sum_yjk_ctymap
		WHERE concern_id ='${concernIdStr}'
		<if test=" ctyIdStr==''">
		AND prvd_id ='${regionIdStr}'
		AND regionId not in (${regionIdStr})
		</if>
		<if test=" ctyIdStr!=''">
		AND regionId IN (${ctyIdStr})
		</if>
		<!-- <![CDATA[
		AND errQty <>0 AND errAmt <>0 
		]]> -->
		AND aud_trm = ${audTrm}
 		order by RN
	</select>
	
	
	<!-- 审计报告之总体数据  1:全公司报告, 2:省公司报告  20160929 add by GuoXY -->
 	<select id="getAuditReportData_totalInfo" resultType="java.util.HashMap" parameterType="java.util.Map">
		select 
		    coalesce(t0.errQty, 0) as errQty_tmp,	
			trim( errQty_tmp (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(22)) ) as errQty,
			
			coalesce(t0.totalNum, 0) as totalQty_tmp,	
			trim( totalQty_tmp (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(22)) ) as totalQty,
			
			t0.qtyPercent as cur_qtyPercent,

			coalesce(t0.errAmt, 0) as errAmt_tmp,	
			trim( errAmt_tmp (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9.99')(VARCHAR(22)) )  as errAmt,
			
			coalesce(t0.tolAmt, 0) as totalAmt_tmp,	
			trim( totalAmt_tmp (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9.99')(VARCHAR(22)) )  as totalAmt,
			
			t0.amtPercent as cur_amtPercent,
	
			
		    coalesce(t1.errQty, 0) as  last_errQty_tmp,	
			trim (last_errQty_tmp(FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(20))) as  last_errQty,	
			
			coalesce(t1.totalNum, 0) as  last_totalQty_tmp,	
			trim (last_totalQty_tmp(FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(20))) as  last_totalQty,
			
			t1.qtyPercent as  last_qtyPercent,

			coalesce(t1.errAmt, 0) as  last_errAmt_tmp,	
			trim (last_errAmt_tmp(FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9.99')(VARCHAR(20))) as  last_errAmt,	
			
			coalesce(t1.tolAmt, 0) as  last_totalAmt_tmp,	
			trim (last_totalAmt_tmp(FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9.99')(VARCHAR(20))) as  last_totalAmt,
			
			t1.amtPercent as  last_amtPercent,
			
			(case when (cur_qtyPercent - last_qtyPercent)>=0 then '上升'  else '下降' end) || (trim ( cast((cur_qtyPercent - last_qtyPercent) as decimal(16,2))(FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) )  as abs_fbQtyPercent, 
			(case when (cur_amtPercent - last_amtPercent)>=0 then '上升' else '下降' end) || (trim ( cast((cur_amtPercent - last_amtPercent)as decimal(16,2))(FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) ) as abs_fbAmtPercent
	
		from  
		( 
			select concern_id,Aud_trm, 
				<if test="prvdId !='10000' ">
				regionId, 
				</if>
				sum(errQty) as errQty, 
				sum(errQty) as errQty_tmp0, 
				sum(totalNum) as totalNum, 
				sum(totalNum) as totalNum_tmp0, 
				(case when totalNum_tmp0=0 then 0 else ( cast(errQty_tmp0 as decimal(16,4))*100 / totalNum_tmp0 )  end) as qtyPercent,

				sum(errAmt) as errAmt, 
				sum(errAmt) as errAmt_tmp0, 
				sum(tolAmt) as tolAmt,
				sum(tolAmt) as tolAmt_tmp0,
				(case when tolAmt_tmp0=0 then 0 else ( cast(errAmt_tmp0 as decimal(16,4))*100 / tolAmt_tmp0) end) as amtPercent

			from  hppdata.sum_yjk_prvdmap 
			where 1=1 
			and concern_id = 1000
			and Aud_trm = ${audTrm}
			<if test="prvdId !='10000' ">
			and regionId = ${prvdId}
			</if>
			group by concern_id, Aud_trm
				<if test="prvdId !='10000' ">
				, regionId 
				</if>
		) as t0 
		LEFT JOIN 
		(
			select concern_id,Aud_trm, 
				<if test="prvdId !='10000' ">
				regionId, 
				</if>
				sum(errQty) as errQty, 
				sum(errQty) as errQty_tmp1, 
				sum(totalNum) as totalNum, 
				sum(totalNum) as totalNum_tmp1, 
				(case when totalNum_tmp1=0 then 0 else ( cast(errQty_tmp1 as decimal(16,4))*100 / totalNum_tmp1 )  end) as qtyPercent,
				
				sum(errAmt) as errAmt, 
				sum(errAmt) as errAmt_tmp1, 
				sum(tolAmt) as tolAmt,
				sum(tolAmt) as tolAmt_tmp1,
				(case when tolAmt_tmp1=0 then 0 else ( cast(errAmt_tmp1 as decimal(16,4))*100 / tolAmt_tmp1) end) as amtPercent
			from  hppdata.sum_yjk_prvdmap 
			where 1=1 
				and concern_id = 1000
				<if test="prvdId !='10000' ">
				and regionId = ${prvdId}
				</if>
				<!-- 这里只能用 # 不能用 $，否则，不识别日期串 -->
				and Aud_trm=cast((add_months(cast( #{audTrm} as date format 'YYYYMM'), -1) (format 'YYYYMM')) as varchar(6))
			group by concern_id, Aud_trm
				<if test="prvdId !='10000' ">
				, regionId 
				</if>
		) as t1 
		ON t0.concern_id = t1.concern_id
		<if test="prvdId !='10000' ">
			and t0.regionId = t1.regionId
		</if>
	</select>
	
	<!-- 审计报告之表格数据，合计行在js中计算  1:全公司报告, 2:省公司报告  20160929 add by GuoXY -->
 	<select id="getAuditReportData_tableInfo" resultType="java.util.HashMap" parameterType="java.util.Map">
 		<!-- 全公司时，审计报告表格中有几个关注点就要调用本方法几次 -->
 		<if test="prvdId =='10000' ">
			select 
				(
				CASE 			
				when  pt.concern_id = 1001 	then '未按规定在系统间同步加载' 
				when  pt.concern_id = 1002 	then '有价卡违规激活' 
				when  pt.concern_id = 1003 	then '有价卡违规销售' 
				when  pt.concern_id = 1004 	then '退换后的坏卡或报废卡未封锁' 
				when  pt.concern_id = 1005 	then '有价卡违规重复使用' 
				end
				) as focusName
				,coalesce(sum(pt.errQty), 0) as errQty	
				,coalesce(sum(pt.errQty), 0) as errQty_tmp
				,coalesce(sum(pt.totalNum), 0) as totalQty
				,coalesce(sum(pt.totalNum), 0) as totalQty_tmp
				,case when totalQty_tmp=0 then 0 else cast(errQty_tmp as decimal(16,2))*100/totalQty_tmp end qtyPercent
				,coalesce(sum(pt.errAmt), 0) as errAmt	
				,coalesce(sum(pt.errAmt), 0) as errAmt_tmp	
				,coalesce(sum(pt.tolAmt), 0) as totalAmt	
				,coalesce(sum(pt.tolAmt), 0) as totalAmt_tmp	
				,case when totalAmt_tmp=0 then 0 else cast(errAmt_tmp as decimal(16,2))*100/totalAmt_tmp end errPercent
			from hppdata.sum_yjk_prvdmap  pt
			where 1=1
				and pt.concern_id = ${concernId}
				and pt.Aud_trm = ${audTrm}
			group by pt.concern_id
		</if> 		
 		<if test="prvdId !='10000' ">
	 		select 
				(
				CASE 			
				when  pt.concern_id = 1001 	then '未按规定在系统间同步加载' 
				when  pt.concern_id = 1002 	then '有价卡违规激活' 
				when  pt.concern_id = 1003 	then '有价卡违规销售' 
				when  pt.concern_id = 1004 	then '退换后的坏卡或报废卡未封锁' 
				when  pt.concern_id = 1005 	then '有价卡违规重复使用' 
				end
				) as focusName
				, coalesce( pt.errQty, 0) as errQty
				, coalesce( pt.totalNum, 0) as totalQty
				, coalesce( pt.qtyPercent, 0) as qtyPercent
				, coalesce( pt.errAmt, 0) as errAmt
				, coalesce( pt.tolAmt, 0) as totalAmt
				, coalesce( pt.errPercent, 0) as errPercent
			from hppdata.sum_yjk_prvdmap  pt
			where 1=1
				and pt.concern_id = ${concernId}
				and pt.Aud_trm = ${audTrm}
				and pt.regionId = ${prvdId}
		</if>
	</select>
	
	
	<select id="getCrmVcDiftData" resultType="java.util.HashMap" parameterType="java.util.Map">
 		 select 
 		 yjk_stat,
 		 case 
			 when yjk_stat='生成'  then '1'
			 when yjk_stat='激活'  then '2'
			 when yjk_stat='已使用'  then '3'
			 when yjk_stat='锁定'  then '4'
		 end as yjk_stat_no,
 		 sum(crm_num)as crm_num ,
 		 sum(vc_num) as vc_num,
 		 sum(all_num) as all_num 
 		 from 
 		 hppdata.crm_vc_num_diff 
 		 where aud_trm=${audTrm}  
 		 <if test="prvdIdFlag=='0' ">
 		 and prvd_id in
 		 <foreach item="item" index="index" collection="prvdIds"
					open="(" separator="," close=")">
					#{item}
		</foreach> 	
		</if>
 		 group by  yjk_stat order by yjk_stat_no
	</select>
</mapper>