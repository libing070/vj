<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  
   		PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<!-- 命名空间 -->
<mapper namespace="QDYK2001">
	
	<!-- 结果集映射 从实体对象到关系数据库 -->
	<resultMap type="java.util.Map"  id="statReport">
		<result property="id" column="id"/>
		<result property="age" column="age"/>
		<result property="name" column="name"/>
		<result property="concernCode" column="concernCode"/>
	</resultMap>
	<!-- 结果集映射 从实体对象到关系数据库 -->
	<resultMap type="java.util.Map"  id="regionTableReport">
		<result property="province" column="province"/>
		<result property="cityCount" column="cityCount"/>
		<result property="numberSum" column="numberErr"/>
		<result property="numberPrecent" column="numberPrecent"/>
		<result property="amountSum" column="amountErr"/>
		<result property="amountPercent" column="amountPercent"/>
	</resultMap>
	
	<resultMap type="java.util.Map"  id="typeTableReport">
		<result property="busiType" column="busiType"/>
		<result property="errType" column="errType"/>
		<result property="numberSum" column="numberErr"/>
		<result property="numberPrecent" column="numberPrecent"/>
		<result property="amountSum" column="amountErr"/>
		<result property="amountPercent" column="amountPercent"/>
	</resultMap>
	
	<!-- 结果集映射 从实体对象到关系数据库 -->
	<resultMap type="java.util.Map"  id="totalAuditReport">
		<result property="statCycle" column="statCycle"/>
		<result property="region" column="region"/>
		<result property="numberSum" column="numberErr"/>
		<result property="numberPrecent" column="numberPrecent"/>
		<result property="amountSum" column="amountErr"/>
		<result property="amountPercent" column="amountPercent"/>
		<result property="concernCode" column="concernCode"/>
	</resultMap>
	
	<!-- 结果集映射 从实体对象到关系数据库 -->
	<resultMap type="java.util.Map"  id="pointAuditReport">
		<result property="pointCode" column="pointCode"/>
		<result property="name" column="name"/>
		<result property="memo" column="memo"/>
		<result property="numberSum" column="numberErr"/>
		<result property="numberPrecent" column="numberPrecent"/>
		<result property="amountSum" column="amountErr"/>
		<result property="amountPercent" column="amountPercent"/>
		<result property="concernCode" column="concernCode"/>
	</resultMap>

	
	
	<resultMap type="java.util.Map"  id="totalReport_ArtrageUserCount">
		<result property="dataBusnArtrageQty" column="dataBusnArtrageQty"/>
		<result property="spCnsmArtrageQty" column="spCnsmArtrageQty"/>
		<result property="spamSmsArtrageQty" column="spamSmsArtrageQty"/>
		<result property="crankCallArtrageQty" column="crankCallArtrageQty"/>
		<result property="groupBusnArtrageQty" column="groupBusnArtrageQty"/>
		<result property="presFeeArtrageQty" column="presFeeArtrageQty"/>
		<result property="artrageUsrsQty" column="artrageUsrsQty"/>	
		
		<result property="dataBusnArtragePercent" column="dataBusnArtragePercent"/>
		<result property="spCnsmArtragePercent" column="spCnsmArtragePercent"/>
		<result property="spamSmsArtragePercent" column="spamSmsArtragePercent"/>
		<result property="crankCallArtragePercent" column="crankCallArtragePercent"/>
		<result property="groupBusnArtragePercent" column="groupBusnArtragePercent"/>
		<result property="presFeeArtragePercent" column="presFeeArtragePercent"/>
		<result property="artrageUsrsPercent" column="artrageUsrsPercent"/>
		
		<result property="numberSum" column="artrageUsrs_tmp"/> <!--地图排序显示用的  -->
		<result property="totalNum" column="tolUsrs_tmp"/>      <!--地图排序显示用的  -->
		
	</resultMap>
	<!-- 总体情况之全国地图 -->
	<select id="totalReport_selectChinaMap" resultMap="totalReport_ArtrageUserCount" parameterType="java.util.Map">
	   
	   <if test="provinceCode==10000">
	   		
	   		select t1.CMCC_prov_prvd_nm as regionName,t1.CMCC_prov_prvd_id as regionId,
		   		t2.dataBusnArtrageQty,t2.dataBusnArtragePercent,
		   		t2.spCnsmArtrageQty,t2.spCnsmArtragePercent,
				t2.spamSmsArtrageQty,t2.spamSmsArtragePercent,
		   		t2.crankCallArtrageQty,t2.crankCallArtragePercent,
		   		t2.groupBusnArtrageQty,t2.groupBusnArtragePercent,
		   		t2.presFeeArtrageQty,t2.presFeeArtragePercent,
		   		t2.artrageUsrsQty,t2.artrageUsrsPercent, 
		   		t2.artrageUsrs_tmp as numberSum, t2.tolUsrs_tmp as totalNum
	   		from HPMGR.ref_dm_cmcc_prov_prvd_cd as t1
	   		left join 
	   		(
				select prvd_id as regionId,
					   dataBusnArtrageQty,      
					spCnsmArtrageQty,        
					spamSmsArtrageQty,       
					crankCallArtrageQty,     
					groupBusnArtrageQty,     
					presFeeArtrageQty,       
					artrageUsrsQty,    
					artrageUsrs_tmp,      
					tolUsrs_tmp,   
					dataBusnArtragePercent, 
					spCnsmArtragePercent, spamSmsArtragePercent,  
					crankCallArtragePercent,
					groupBusnArtragePercent,
					presFeeArtragePercent,  
					artrageUsrsPercent
					      
				  from HPBUS.Sum_qdyk_2001_prvd 
					
				  where 1=1
			 	  and chnl_class='0'
			 	  <![CDATA[and prvd_id<>'10000']]>
					<if test="statCycle!=null">
						and Aud_trm=#{statCycle}
					</if>
					<if test="audTrmSTR!=null">
						and Aud_trm IN ${audTrmSTR}
					</if>
			) t2
			on t1.CMCC_prov_prvd_id=t2.regionId
			order by t2.artrageUsrsPercent desc
		</if>
		<!-- 20150512 增加空格处理 -->
		<if test="provinceCode!=10000">
			select t1.CMCC_prvd_nm_short regionName,t1.CMCC_prvd_cd as regionId,
		   		trim(t2.dataBusnArtrageQty),t2.dataBusnArtragePercent,
		   		trim(t2.spCnsmArtrageQty),t2.spCnsmArtragePercent,
		   		trim(t2.spamSmsArtrageQty),t2.spamSmsArtragePercent,
		   		trim(t2.crankCallArtrageQty),t2.crankCallArtragePercent,
		   		trim(t2.groupBusnArtrageQty),t2.groupBusnArtragePercent,
		   		trim(t2.presFeeArtrageQty),t2.presFeeArtragePercent,
		   		trim(t2.artrageUsrsQty),t2.artrageUsrsPercent,
		   		trim(t2.artrageUsrs_tmp) as numberSum, trim(t2.tolUsrs_tmp) as totalNum
			from HPMGR.TB_SUM_PRVD_NAME	as t1
			left join
			(		
				select cty_id as regionId,
					   dataBusnArtrageQty,      
					spCnsmArtrageQty,        
					spamSmsArtrageQty,       
					crankCallArtrageQty,     
					groupBusnArtrageQty,     
					presFeeArtrageQty,       
					artrageUsrsQty,  
					artrageUsrs_tmp, 
					tolUsrs_tmp,        
					dataBusnArtragePercent, 
					spCnsmArtragePercent, spamSmsArtragePercent,
					crankCallArtragePercent,
					groupBusnArtragePercent,
					presFeeArtragePercent,  
					artrageUsrsPercent      
				  from hpbus.Sum_qdyk_2001_cty
					
				  where 1=1
			 	  and chnl_class='0'
					<if test="statCycle!=null">
						and Aud_trm=#{statCycle}
					</if>
					<if test="audTrmSTR!=null">
						and Aud_trm IN ${audTrmSTR}
					</if>
				and	prvd_id=#{provinceCode}
			) t2
			on t1.CMCC_prvd_cd=t2.regionId
			where t1.CMCC_prov_prvd_id=#{provinceCode}
			order by t2.artrageUsrsPercent desc
		</if>
	</select>
	
	<!-- 按套利模式统计每种套利模式的用户数  -->
	<select id="totalReport_selectArtrageUser" resultMap="totalReport_ArtrageUserCount"  parameterType="java.util.Map">
		
				select prvd_id as regionId,
				
					dataBusnArtrageQty,      
					spCnsmArtrageQty,        
					spamSmsArtrageQty,       
					crankCallArtrageQty,     
					groupBusnArtrageQty,     
					presFeeArtrageQty,       
					artrageUsrsQty,  
						
					dataBusnArtragePercent, 
					spCnsmArtragePercent,spamSmsArtragePercent,  
					crankCallArtragePercent,
					groupBusnArtragePercent,
					presFeeArtragePercent,  
					artrageUsrsPercent      
					
				from HPBUS.Sum_qdyk_2001_prvd 
				where 1=1
		 	  	and chnl_class='0'
				and Aud_trm=#{statCycle}
					<if test="audTrmSTR!=null">
						and Aud_trm IN ${audTrmSTR}
					</if>
					<if test="userCityId!=10000">
						and prvd_id = #{userCityId}
					</if>
					<if test="provinceCode!=null">	
						and prvd_id=#{provinceCode}
					</if>	
	</select>


	<!-- 统计分析之按地时间趋势"-->
	<select id="statReport_timeTrend" resultType="java.util.HashMap"
		parameterType="java.util.Map">
		
		<if test="params.groupByField=='prvd_id'">
			SELECT
			Aud_trm as statisticalObj, 
			
			
			
			SUM(tolusrs_tmp) as totalQty, 
			SUM(dataBusnArtrageQty_tmp) as a_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(a_errQty as decimal(16,2))*100/totalQty END a_qtyPercent,
			
			SUM(spCnsmArtrageQty_tmp) as b_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(b_errQty as decimal(16,2))*100/totalQty END b_qtyPercent,
			
			SUM(spamSmsArtrageQty_tmp) as c_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(c_errQty as decimal(16,2))*100/totalQty END c_qtyPercent,
			
			SUM(crankCallArtrageQty_tmp) as d_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(d_errQty as decimal(16,2))*100/totalQty END d_qtyPercent,
			
			SUM(groupBusnArtrageQty_tmp) as e_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(e_errQty as decimal(16,2))*100/totalQty END e_qtyPercent,
			
			SUM(presFeeArtrageQty_tmp) as f_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(f_errQty as decimal(16,2))*100/totalQty END f_qtyPercent,
			
			
			SUM(artrageUsrs_tmp) as total_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(total_errQty as decimal(16,2))*100/totalQty END total_qtyPercent
			

			FROM HPBUS.Sum_qdyk_2001_prvd
			WHERE 1=1
	 	  	and chnl_class='0'
			<![CDATA[and prvd_id<>10000]]>
			 <if test="params.dateF!=null">
				<![CDATA[and statisticalObj >= #{params.dateF}]]>
			</if>
			 <if test="params.dateT!=null">
				<![CDATA[and statisticalObj <= #{params.dateT}]]>
			</if>
			<if test="params.audTrmSTR!=null">
				and statisticalObj IN ${params.audTrmSTR}
			</if>
			
			<if test="params.selProvCodeSTR!=null">
				and prvd_id in 
	        		${params.selProvCodeSTR}
			</if>
			group by Aud_trm
		</if>
		<if test="params.groupByField=='cty_id'">

			SELECT
			Aud_trm as statisticalObj, 
			
			
			
			SUM(tolusrs_tmp) as totalQty, 
			SUM(dataBusnArtrageQty_tmp) as a_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(a_errQty as decimal(16,2))*100/totalQty END a_qtyPercent,
			
			SUM(spCnsmArtrageQty_tmp) as b_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(b_errQty as decimal(16,2))*100/totalQty END b_qtyPercent,
			
			SUM(spamSmsArtrageQty_tmp) as c_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(c_errQty as decimal(16,2))*100/totalQty END c_qtyPercent,
			
			SUM(crankCallArtrageQty_tmp) as d_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(d_errQty as decimal(16,2))*100/totalQty END d_qtyPercent,
			
			SUM(groupBusnArtrageQty_tmp) as e_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(e_errQty as decimal(16,2))*100/totalQty END e_qtyPercent,
			
			SUM(presFeeArtrageQty_tmp) as f_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(f_errQty as decimal(16,2))*100/totalQty END f_qtyPercent,
			
			
			SUM(artrageUsrs_tmp) as total_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(total_errQty as decimal(16,2))*100/totalQty END total_qtyPercent
			
			FROM HPBUS.Sum_qdyk_2001_cty
			WHERE 1=1
	 	  	and chnl_class='0'
			 <if test="params.dateF!=null">
				<![CDATA[and statisticalObj >= #{params.dateF}]]>
			</if>
			 <if test="params.dateT!=null">
				<![CDATA[and statisticalObj <= #{params.dateT}]]>
			</if>
			<if test="params.audTrmSTR!=null">
				and statisticalObj IN ${params.audTrmSTR}
			</if>
			
			<if test="params.selCityCodeSTR!=null">
				and cty_id in 
	        		${params.selCityCodeSTR}
			</if>
			group by Aud_trm

		</if>
	</select><!-- 		ORDER BY statisticalObj DESC -->
	
	<!-- 统计分析之地区横向对比"-->
	<!-- dataBusnArtragePercent as a_qtyPercent, 
			spCnsmArtragePercent as b_qtyPercent,
			spamSmsArtragePercent as c_qtyPercent,  
			crankCallArtragePercent as d_qtyPercent,
			groupBusnArtragePercent as e_qtyPercent,
			presFeeArtragePercent as f_qtyPercent,
			artrageUsrsPercent as total_qtyPercent
			 -->
	<select id="statReport_areaTrend" resultType="java.util.HashMap"
		parameterType="java.util.Map">
		
		<if test="params.selProvCode!=null or(params.selProvCode==null and params.selCityCode==null)">
			
		select max(prvd_name) as statisticalObj ,prvd_id as regionId,
			sum(cityCount) as cityCount,
			sum(chnlCount) as chnlCount,
			sum(tolusrs_tmp) as totalQty, 
			sum(dataBusnArtrageQty_tmp) as a_errQty,      
			sum(spCnsmArtrageQty_tmp) as b_errQty,        
			sum(spamSmsArtrageQty_tmp) as c_errQty,       
			sum(crankCallArtrageQty_tmp) as d_errQty,     
			sum(groupBusnArtrageQty_tmp) as e_errQty,
			sum(presFeeArtrageQty_tmp) as f_errQty,
			sum(artrageUsrs_tmp) as total_errQty, 
			
			       
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(a_errQty*100 as decimal(16,2))/totalQty END as a_qtyPercent, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(b_errQty*100 as decimal(16,2))/totalQty END as b_qtyPercent,
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(c_errQty*100 as decimal(16,2))/totalQty END as c_qtyPercent,  
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(d_errQty*100 as decimal(16,2))/totalQty END as d_qtyPercent,
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(e_errQty*100 as decimal(16,2))/totalQty END as e_qtyPercent,
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(f_errQty*100 as decimal(16,2))/totalQty END as f_qtyPercent,
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(total_errQty*100 as decimal(16,2))/totalQty END as total_qtyPercent
		FROM HPBUS.Sum_qdyk_2001_prvd
		WHERE 1=1
			and chnl_class='0'
			<![CDATA[and prvd_id<>10000]]>
			 <if test="params.dateF!=null">
				<![CDATA[and Aud_trm >= #{params.dateF}]]>
			</if>
			 <if test="params.dateT!=null">
				<![CDATA[and Aud_trm <= #{params.dateT}]]>
			</if> 
			<if test="params.selProvCodeSTR!=null">
				and prvd_id in 
		 		${params.selProvCodeSTR}
			</if>
			group by prvd_id	 
		</if>
		
		
		
		
		<if test="params.selCityCode!=null">
		
		select max(cty_name_short) as statisticalObj ,cty_id as regionId,
			prvd_id,
			1 as cityCount,
			sum(chnlCount) as chnlCount,
			sum(tolusrs_tmp) as totalQty,
			sum(dataBusnArtrageQty_tmp) as a_errQty,      
			sum(spCnsmArtrageQty_tmp) as b_errQty,        
			sum(spamSmsArtrageQty_tmp) as c_errQty,       
			sum(crankCallArtrageQty_tmp) as d_errQty,     
			sum(groupBusnArtrageQty_tmp) as e_errQty,
			sum(presFeeArtrageQty_tmp) as f_errQty, 
			sum(artrageUsrs_tmp) as total_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(a_errQty*100 as decimal(16,2))/totalQty END as a_qtyPercent, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(b_errQty*100 as decimal(16,2))/totalQty END as b_qtyPercent,
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(c_errQty*100 as decimal(16,2))/totalQty END as c_qtyPercent,  
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(d_errQty*100 as decimal(16,2))/totalQty END as d_qtyPercent,
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(e_errQty*100 as decimal(16,2))/totalQty END as e_qtyPercent,
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(f_errQty*100 as decimal(16,2))/totalQty END as f_qtyPercent,
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(total_errQty*100 as decimal(16,2))/totalQty END as total_qtyPercent
		FROM HPBUS.Sum_qdyk_2001_cty
		WHERE 1=1
			and chnl_class='0'
			<![CDATA[and prvd_id<>10000]]>
			 <if test="params.dateF!=null">
				<![CDATA[and Aud_trm >= #{params.dateF}]]>
			</if>
			 <if test="params.dateT!=null">
				<![CDATA[and Aud_trm <= #{params.dateT}]]>
			</if> 
			<if test="params.selCityCodeSTR!=null">
				and cty_id in 
		 		${params.selCityCodeSTR}
			</if>
			group by cty_id,prvd_id
		</if>
	</select><!-- ORDER BY t.prvd_id  DESC -->


	<!-- 统计报表之有价卡类型错误类型"-->
	<select id="statReport_cardErrTrend" resultType="java.util.HashMap"
		parameterType="java.util.Map">
		select yjk_type.yjk_typ_name as busiTypeName,yjk_type.yjk_typ_cd as busiType,infraction_type.infraction_typ_cd as errType,infraction_type.infraction_typ_name as errName,dataReport.errQty,dataReport.totalQty,dataReport.qtyPercent,
		dataReport.totalAmount,dataReport.errAmount,dataReport.amountPercent from 
		(
		SELECT
			t.yjk_typ AS busiType,
			t.infraction_typ AS errType,
			SUM(t.tol_num) AS totalQty,
			SUM(t.infraction_num) AS errQty,
			CAST(SUM(t.infraction_num*100) as decimal(16,2)) / SUM(t.tol_num) AS qtyPercent,
			SUM(t.tol_amt) AS totalAmount,
			SUM(t.infraction_amt) AS errAmount,
			CAST(SUM(t.infraction_amt*100) as decimal(16,2)) / SUM(t.tol_amt) AS amountPercent
		FROM  HPBUS.sum_yjk_test t
		WHERE 1=1
		 <if test="params.dateF!=null">
			<![CDATA[and Aud_trm >= #{params.dateF}]]>
		</if>
		 <if test="params.dateT!=null">
			<![CDATA[and Aud_trm <= #{params.dateT}]]>
		</if>
		<if test="params.audTrmSTR!=null">
			and Aud_trm IN ${params.audTrmSTR}
		</if>
		<if test="params.selProvCodeSTR!=null">
			and t.prvd_id in 
        		${params.selProvCodeSTR}
		</if>
		<if test="params.selCityCodeSTR!=null">
			and t.cty_id in 
        		${params.selCityCodeSTR}
		</if>
		<if test="params.yjkTypeSTR!=null">
			and t.yjk_typ in 
        		${params.yjkTypeSTR}
		</if>
		<if test="params.wgTypeSTR!=null">
			and t.infraction_typ in 
        		${params.wgTypeSTR}
		</if>
		GROUP BY t.yjk_typ, t.infraction_typ 
		) as dataReport left join 
		 HPMGR.Dim_yjk_typ as yjk_type on dataReport.busiType = yjk_type.yjk_typ_cd 
		 left join  HPMGR.Dim_infraction_typ as infraction_type on dataReport.errType =  infraction_type.infraction_typ_cd
	</select><!-- ORDER BY t.prvd_id  DESC -->
		
	
	<!-- 报表分析之按地区统计 -->
	<!-- 
			SUM(t.infraction_num) AS errQty,
			(SUM(t.infraction_num) / SUM(t.tol_num) *100) AS qtyPercent,
			SUM(t.infraction_amt) AS errAmount,
			(SUM(t.infraction_amt) /SUM(t.tol_amt) *100) AS amountPercent -->
	<select id="tableReport_selectRegion" resultMap="regionTableReport"  parameterType="java.util.Map">
		select t.prvd_id,count(t.cty_id) cityCount,
		sum(t.infraction_num) numberErr,
		CAST(SUM(t.infraction_num*100) as decimal(16,2)) / SUM(t.tol_num) AS numberPrecent,
		sum(t.infraction_amt) amountErr,
		CAST(SUM(t.infraction_amt*100) as decimal(16,2)) / SUM(t.tol_amt) AS amountPercent		
		from HPBUS.sum_yjk_test t
		WHERE 1=1
		 <if test="params.dateF!=null">
			<![CDATA[and Aud_trm >= #{params.dateF}]]>
		</if>
		 <if test="params.dateT!=null">
			<![CDATA[and Aud_trm <= #{params.dateT}]]>
		</if>
		<if test="params.audTrmSTR!=null">
			and Aud_trm IN ${params.audTrmSTR}
		</if>
		group by t.prvd_id 
		
	</select><!-- order by t.cityCount desc  -->
	
	<!-- 报表分析之按类型统计 -->
	<select id="tableReport_selectType" resultMap="typeTableReport"  parameterType="java.util.Map">
		select t.busiType,t.errType,
		sum(t.infraction_num) numberErr,
		CAST(SUM(t.infraction_num*100) as decimal(16,2)) / SUM(t.tol_num) AS numberPrecent,
		sum(t.infraction_amt) amountErr,
		CAST(SUM(t.infraction_amt*100) as decimal(16,2)) / SUM(t.tol_amt) AS amountPercent
		from HPBUS.sum_yjk_test t
		WHERE 1=1
		 <if test="params.dateF!=null">
			<![CDATA[and Aud_trm >= #{params.dateF}]]>
		</if>
		 <if test="params.dateT!=null">
			<![CDATA[and Aud_trm <= #{params.dateT}]]>
		</if>
		<if test="params.audTrmSTR!=null">
			and Aud_trm IN ${params.audTrmSTR}
		</if>
		GROUP BY t.yjk_typ, t.infraction_typ 
		
	</select><!-- order by numberSum desc  -->
	
	
	
	<!-- 报表分析之按地区统计 之按城市统计"-->
	<select id="tableReport_selectRegion_Detail" resultType="java.util.HashMap"
		parameterType="java.util.Map">
		SELECT
			cty_name_short as regionName ,cty_id as statisticalObj,
			
			chnlCount as chnlCount,
			
			dataBusnArtrageQty as a_errQty,      
			spCnsmArtrageQty as b_errQty,        
			spamSmsArtrageQty as c_errQty,       
			crankCallArtrageQty as d_errQty,     
			groupBusnArtrageQty as e_errQty,
			presFeeArtrageQty as f_errQty,
			artrageUsrsQty as total_errQty, 
			       
			dataBusnArtragePercent as a_qtyPercent, 
			spCnsmArtragePercent as b_qtyPercent,
			spamSmsArtragePercent as c_qtyPercent,  
			crankCallArtragePercent as d_qtyPercent,
			groupBusnArtragePercent as e_qtyPercent,
			presFeeArtragePercent as f_qtyPercent,
			artrageUsrsPercent as total_qtyPercent
			
			
		FROM  HPBUS.sum_qdyk_2001_cty t
		WHERE 1=1 
		AND artrageUsrsQty>0
		AND chnl_class=0
		 <if test="params.dateF!=null">
			<![CDATA[and Aud_trm >= #{params.dateF}]]>
		</if>
		 <if test="params.dateT!=null">
			<![CDATA[and Aud_trm <= #{params.dateT}]]>
		</if>
		<if test="params.audTrmSTR!=null">
			and Aud_trm IN ${params.audTrmSTR}
		</if>
		<if test="params.selProvCodeSTR!=null">
			and t.prvd_id in 
        		${params.selProvCodeSTR}
		</if>
		<if test="params.selCityCodeSTR!=null">
			and t.cty_id in 
        		${params.selCityCodeSTR}
		</if>
		
				
		
	</select><!-- ORDER BY t.city  DESC -->
	
	
	<!-- 报表分析之按地区统计 之按城市统计,按渠道下钻"-->
	<select id="tableReport_selectChnl_Detail" resultType="java.util.HashMap"
		parameterType="java.util.Map">
		SELECT dataReport.* from (
		SELECT
			t.chnl_name AS statisticalObj,
			t.chnl_name AS chnlName,
			COUNT(DISTINCT (t.cty_id)) as cityCount,
			
			SUM(t.tol_usrs) as totalQty, 
			
			SUM(t.data_busn_artrage_qty) as a_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(a_errQty as decimal(16,2))*100/totalQty END a_qtyPercent,
			
			SUM(t.SP_cnsm_artrage_qty) as b_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(b_errQty as decimal(16,2))*100/totalQty END b_qtyPercent,
			
			SUM(t.spam_sms_artrage_qty) as c_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(c_errQty as decimal(16,2))*100/totalQty END c_qtyPercent,
			
			SUM(t.crank_call_artrage_qty) as d_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(d_errQty as decimal(16,2))*100/totalQty END d_qtyPercent,
			
			SUM(t.group_busn_artrage_qty) as e_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(e_errQty as decimal(16,2))*100/totalQty END e_qtyPercent,
			
			SUM(t.pres_fee_artrage_qty) as f_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(f_errQty as decimal(16,2))*100/totalQty END f_qtyPercent,
			
			SUM(t.artrage_usrs) as total_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(total_errQty as decimal(16,2))*100/totalQty END total_qtyPercent
			
		FROM  HPBUS.sum_qdyk_2001 t
		WHERE 1=1 AND t.artrage_usrs>0 
		and chnl_stat='1'
		and tol_usrs>0 
		 <if test="params.dateF!=null">
			<![CDATA[and Aud_trm >= #{params.dateF}]]>
		</if>
		 <if test="params.dateT!=null">
			<![CDATA[and Aud_trm <= #{params.dateT}]]>
		</if>
		<if test="params.audTrmSTR!=null">
			and Aud_trm IN ${params.audTrmSTR}
		</if>
		<if test="params.selProvCodeSTR!=null">
			and t.prvd_id in 
        		${params.selProvCodeSTR}
		</if>
		<if test="params.selCityCodeSTR!=null">
			and t.cty_id in 
        		${params.selCityCodeSTR}
		</if>
		<if test="params.chnlId!=null">
			and t.chnl_name in 
        		${params.chnlId}
		</if>
		GROUP BY t.chnl_name ) as dataReport
				
		
	</select><!-- left join (
				select CMCC_prvd_nm_short as regionName ,CMCC_prvd_cd as regionId  
				from  HPMGR.TB_SUM_PRVD_NAME ) as provReport
				on dataReport.statisticalObj = provReport.regionId -->
	
	
	
	
	<!-- 报表分析之套利明细and chnl_stat='1' and tol_usrs>0-->
	<select id="qdyk_Detail" resultType="java.util.HashMap"
		parameterType="java.util.Map">
		
		select dataReport.*,cityReport.CMCC_prvd_nm_short as cty_name from 
		(SELECT		Gen_date, Aud_trm, prvd_id, cty_id, user_id, rase_crd_no,
		ent_dt, chnl_id, chnl_type, chnl_class, chnl_class_nm, chnl_nm,
		Same_IMEI, Same_bts, Same_ops_nbr, Same_cnsm_amt, open_ftn, open_139mail,
		Open_MM, Open_mnews, Open_mbl_wlt, Open_WMC, Open_Stack_pack,
		Zero_roam, Less_bts_qty, Less_becall_days, Less_pay_comm_qty,
		less_becall_cntct_pqty, zero_pay_fee, 
		
		data_busn_artrage, SP_cnsm_artrage,
		spam_sms_artrage, crank_call_artrage, 
		group_busn_artrage, pres_fee_artrage,
		
		frst_ptop_sms_qty, frst_Comm_days, frst_mstfrqcy_IMEI, frst_mstfrqcy_ops_nbr,
		frst_call_cntct_pqty, frst_call_tot_qty, frst_becall_cntct_pqty,
		frst_roam_call_qty, frst_mstfrqcy_bts, frst_becall_days, frst_pay_comm_qty,
		secd_ptop_sms_qty, secd_Comm_days, secd_mstfrqcy_IMEI, secd_mstfrqcy_ops_nbr,
		secd_call_cntct_pqty, secd_call_tot_qty, secd_becall_cntct_pqty,
		Secd_roam_call_qty, secd_mstfrqcy_bts, secd_becall_days, secd_pay_comm_qty,
		thrd_ptop_sms_qty, thrd_Comm_days, thrd_mstfrqcy_IMEI, thrd_mstfrqcy_ops_nbr,
		thrd_call_cntct_pqty, thrd_call_tot_qty, thrd_becall_cntct_pqty,
		Thrd_roam_call_qty, thrd_mstfrqcy_bts, thrd_becall_days, thrd_pay_comm_qty
		FROM HPBUS.Det_qdyk_2001 t
		WHERE 1=1
		
		 
		
		<if test="params.dateF!=null">
			<![CDATA[and Aud_trm >= #{params.dateF}]]>
		</if>
		<if test="params.dateT!=null">
			<![CDATA[and Aud_trm <= #{params.dateT}]]>
		</if>
		
		<if test="params.audTrmSTR!=null">
			and Aud_trm IN ${params.audTrmSTR}
		</if>
		<if test="params.chnlId!=null and params.chnlId!=''">
			and chnl_id =#{params.chnlId}
		</if>
		
		
		<if test="params.gainModel==1">
			and data_busn_artrage ='1'
		</if>
		
		<if test="params.gainModel==2">
			and SP_cnsm_artrage ='1'
		</if>
		
		<if test="params.gainModel==3">
			and spam_sms_artrage ='1'
		</if>
		
		<if test="params.gainModel==4">
			and crank_call_artrage ='1'
		</if>
		
		<if test="params.gainModel==5">
			and group_busn_artrage ='1'
		</if>
		
		<if test="params.gainModel==6">
			and pres_fee_artrage ='1'
		</if>
		
		<if test="params.gainModel==7">
			and (data_busn_artrage ='1'
			or SP_cnsm_artrage ='1'
			or spam_sms_artrage ='1'
			or crank_call_artrage ='1'
			or group_busn_artrage ='1'
			or pres_fee_artrage ='1')
		</if>
		
		
		<if test="params.selProvCodeSTR!=null and params.selCityCodeSTR==null">
			and t.prvd_id in 
        		${params.selProvCodeSTR}
		</if>
		<if test="params.selCityCodeSTR!=null">
			and t.cty_id in 
        		${params.selCityCodeSTR}
		</if>	
		)  as dataReport left join HPMGR.TB_SUM_PRVD_NAME as cityReport
		on dataReport.cty_id = cityReport.CMCC_prvd_cd
	</select>
	
	<select id="provinceCountByChnl" resultType="java.util.HashMap"  parameterType="java.util.Map">
		SELECT			
			t.chnl_id AS statisticalObj,
			CMCC_prvd_nm_short as regionName ,
			CMCC_prvd_cd as regionId,  	
			
			MAX(t.chnl_name) AS chnlName,
			COUNT(DISTINCT (t.cty_id)) as cityCount,
			
			SUM(t.tol_usrs) as totalQty, 
			
			
			SUM(t.data_busn_artrage_qty) as a_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(a_errQty as decimal(16,2))*100/totalQty END a_qtyPercent,
			
			SUM(t.SP_cnsm_artrage_qty) as b_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(b_errQty as decimal(16,2))*100/totalQty END b_qtyPercent,
			
			SUM(t.spam_sms_artrage_qty) as c_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(c_errQty as decimal(16,2))*100/totalQty END c_qtyPercent,
			
			SUM(t.crank_call_artrage_qty) as d_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(d_errQty as decimal(16,2))*100/totalQty END d_qtyPercent,
			
			SUM(t.group_busn_artrage_qty) as e_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(e_errQty as decimal(16,2))*100/totalQty END e_qtyPercent,
			
			SUM(t.pres_fee_artrage_qty) as f_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(f_errQty as decimal(16,2))*100/totalQty END f_qtyPercent,
			
			SUM(t.artrage_usrs) as total_errQty, 
			CASE WHEN totalQty=0 THEN 0 ELSE CAST(total_errQty as decimal(16,2))*100/totalQty END total_qtyPercent
			
			from HPBUS.Sum_qdyk_2001 t join HPMGR.TB_SUM_PRVD_NAME h on t.cty_id=h.CMCC_prvd_cd
			
		WHERE 1=1 and t.artrage_usrs>0 
		and chnl_stat='1'
		and tol_usrs>0 
		 <if test="params.dateF!=null">
			<![CDATA[and Aud_trm >= #{params.dateF}]]>
		</if>
		 <if test="params.dateT!=null">
			<![CDATA[and Aud_trm <= #{params.dateT}]]>
		</if>
		
		<if test="params.audTrmSTR!=null">
			and Aud_trm IN ${params.audTrmSTR}
		</if>
		
		<if test="params.selProvCodeSTR!=null">
			and t.prvd_id in 
        		${params.selProvCodeSTR}
		</if>
		<if test="params.selCityCodeSTR!=null">
			and t.cty_id in 
        		${params.selCityCodeSTR}
		</if>
		
		GROUP BY t.chnl_id,
		CMCC_prvd_nm_short,
		CMCC_prvd_cd
				
	</select>
	
	
	<resultMap type="java.util.Map"  id="auditReport_total">

		<result property="errQty" column="errQty"/>
		<result property="totalQty" column="totalQty"/>
		<result property="qtyPercent" column="qtyPercent"/>
		<result property="fbQtyPercent" column="fbQtyPercent"/>
		
		<result property="errChnlQty" column="errChnlQty"/>
		<result property="totalChnlQty" column="totalChnlQty"/>
		<result property="qtyChnlPercent" column="qtyChnlPercent"/>	
		<result property="fbChnlPercent" column="fbChnlPercent"/>

	</resultMap>
			
	<!-- 全渠道的统计信息，不区分1-自有渠道和2-社会渠道 -->
	<select id="auditReport_selectChnl_all" resultMap="auditReport_total"  parameterType="java.util.Map">
				
		select 
				coalesce(sum(artrage_usrs),0) as errQty_tmp,				
				coalesce(sum(tol_usrs),0) as totalQty_tmp, 
				coalesce(sum(m1_artrage_usrs),0) as m1_errQty_tmp,
				coalesce(sum(m1_tol_usrs),0) as m1_totalQty_tmp,
				
				coalesce(sum(case when artrage_usrs=0 then 0 else 1 end),0) as errChnlQty_tmp,
				coalesce(sum(case when chnl_stat=0 then 0 else 1 end),0)  as totalChnlQty_tmp,
				coalesce(sum(case when m1_artrage_usrs=0 or m1_artrage_usrs is null then 0 else 1 end),0) as m1_errChnlQty_tmp,
				coalesce(sum(case when m1_chnl_stat=0 then 0 else 1 end),0) as m1_totalChnlQty_tmp,
				
				trim (errQty_tmp(FORMAT 'ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(15))) as errQty,
				trim (totalQty_tmp(FORMAT 'ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(15))) as totalQty,				
				trim (cast(errQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as errQty_w,
				trim (cast(totalQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as totalQty_w,
				trim ((case when totalQty_tmp=0 then 0 else cast(errQty_tmp as decimal(16,2))*100/totalQty_tmp end ) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as qtyPercent , 
				trim ((case when m1_totalQty_tmp=0 then 0 else cast(m1_errQty_tmp as decimal(16,2))*100/m1_totalQty_tmp end ) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as m1_qtyPercent ,
				
				trim (errChnlQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as errChnlQty,
				trim (totalChnlQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as totalChnlQty,	
				trim (cast(errChnlQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as errChnlQty_w,
				trim (cast(totalChnlQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as totalChnlQty_w,
				trim ((case when totalChnlQty_tmp=0 then 0 else cast(errChnlQty_tmp as decimal(16,2))*100/totalChnlQty_tmp end) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as qtyChnlPercent ,
				trim ((case when m1_totalChnlQty_tmp=0 then 0 else cast(m1_errChnlQty_tmp as decimal(16,2))*100/m1_totalChnlQty_tmp end) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as m1_qtyChnlPercent ,  
							
				(case when (qtyPercent-m1_qtyPercent)>=0 then '上升'  else '下降' end) ||	(trim (case when m1_errQty_tmp=0 then 'N/A' else (cast((qtyPercent-m1_qtyPercent) as decimal(16,2))(FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end))  as abs_fbQtyPercent , 
				(case when (qtyChnlPercent-m1_qtyChnlPercent)>=0 then '上升' else '下降' end)|| (trim (case when m1_errChnlQty_tmp=0 then 'N/A' else (cast((qtyChnlPercent-m1_qtyChnlPercent)as decimal(16,2))(FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end)) as abs_fbChnlPercent	,
				
				trim (case when m1_errQty_tmp=0 then 'N/A' else (cast((m1_errQty_tmp - errQty_tmp) as decimal(16,2))*100/m1_errQty_tmp (FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end)  as fbQtyPercent , 
				trim (case when m1_errChnlQty_tmp=0 then 'N/A' else (cast((m1_errChnlQty_tmp - errChnlQty_tmp)as decimal(16,2))*100/m1_errChnlQty_tmp (FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end) as fbChnlPercent	
				
				from hpbus.Sum_qdyk_2001_compare
				<where> 1=1
					and Aud_trm=#{statCycle}
		<if test="audTrmSTR!=null">
			and Aud_trm IN ${audTrmSTR}
		</if>
		
					<if test="userCityId!=10000">
						and prvd_id = #{userCityId}
					</if>
					<if test="provinceCode!=10000">	
						and prvd_id=#{provinceCode}
					</if>
				</where>
	</select>
	
	<!-- 自有渠道的统计信息 -->
	<select id="auditReport_selectChnl_1" resultMap="auditReport_total"  parameterType="java.util.Map">
				
		select 		
				coalesce(sum(artrage_usrs),0) as errQty_tmp,				
				coalesce(sum(tol_usrs),0) as totalQty_tmp, 
				coalesce(sum(m1_artrage_usrs),0) as m1_errQty_tmp,
				coalesce(sum(m1_tol_usrs),0) as m1_totalQty_tmp,
				
				coalesce(sum(case when artrage_usrs=0 then 0 else 1 end),0) as errChnlQty_tmp,
				coalesce(sum(case when chnl_stat=0 then 0 else 1 end),0)  as totalChnlQty_tmp,
				coalesce(sum(case when m1_artrage_usrs=0 or m1_artrage_usrs is null then 0 else 1 end),0) as m1_errChnlQty_tmp,
				coalesce(sum(case when m1_chnl_stat=0 then 0 else 1 end),0) as m1_totalChnlQty_tmp,
				
				trim (errQty_tmp(FORMAT 'ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(15))) as errQty,
				trim (totalQty_tmp(FORMAT 'ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(15))) as totalQty,				
				trim (cast(errQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as errQty_w,
				trim (cast(totalQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as totalQty_w,
				trim ((case when totalQty_tmp=0 then 0 else cast(errQty_tmp as decimal(16,2))*100/totalQty_tmp end ) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as qtyPercent , 
				trim ((case when m1_totalQty_tmp=0 then 0 else cast(m1_errQty_tmp as decimal(16,2))*100/m1_totalQty_tmp end ) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as m1_qtyPercent ,
				
				trim (errChnlQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as errChnlQty,
				trim (totalChnlQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as totalChnlQty,	
				trim (cast(errChnlQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as errChnlQty_w,
				trim (cast(totalChnlQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as totalChnlQty_w,
				trim ((case when totalChnlQty_tmp=0 then 0 else cast(errChnlQty_tmp as decimal(16,2))*100/totalChnlQty_tmp end) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as qtyChnlPercent , 
				trim ((case when m1_totalChnlQty_tmp=0 then 0 else cast(m1_errChnlQty_tmp as decimal(16,2))*100/m1_totalChnlQty_tmp end) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as m1_qtyChnlPercent ,
				
				(case when (qtyPercent-m1_qtyPercent)>=0 then '上升'  else '下降' end) ||	(trim (case when m1_errQty_tmp=0 then 'N/A' else (cast((qtyPercent-m1_qtyPercent) as decimal(16,2))(FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end))  as abs_fbQtyPercent , 
				(case when (qtyChnlPercent-m1_qtyChnlPercent)>=0 then '上升' else '下降' end)|| (trim (case when m1_errChnlQty_tmp=0 then 'N/A' else (cast((qtyChnlPercent-m1_qtyChnlPercent)as decimal(16,2))(FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end)) as abs_fbChnlPercent	,
						
				trim (case when m1_errQty_tmp=0 then 'N/A' else (cast((m1_errQty_tmp - errQty_tmp) as decimal(16,2))*100/m1_errQty_tmp (FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end)  as fbQtyPercent , 
				trim (case when m1_errChnlQty_tmp=0 then 'N/A' else (cast((m1_errChnlQty_tmp - errChnlQty_tmp)as decimal(16,2))*100/m1_errChnlQty_tmp (FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end) as fbChnlPercent	
								
				from hpbus.Sum_qdyk_2001_compare
				<where> 1=1
					and Aud_trm=#{statCycle}
					<if test="audTrmSTR!=null">
						and Aud_trm IN ${audTrmSTR}
					</if>
					<if test="userCityId!=10000">
						and prvd_id = #{userCityId}
					</if>
					<if test="provinceCode!=10000">	
						and prvd_id=#{provinceCode}
					</if>
					and chnl_class='1'
				</where>	
	</select>
	<!-- 社会渠道的统计信息 -->
	<select id="auditReport_selectChnl_2" resultMap="auditReport_total"  parameterType="java.util.Map">
				
		select 
				coalesce(sum(artrage_usrs),0) as errQty_tmp,				
				coalesce(sum(tol_usrs),0) as totalQty_tmp, 
				coalesce(sum(m1_artrage_usrs),0) as m1_errQty_tmp,
				coalesce(sum(m1_tol_usrs),0) as m1_totalQty_tmp,
				
				coalesce(sum(case when artrage_usrs=0 then 0 else 1 end),0) as errChnlQty_tmp,
				coalesce(sum(case when chnl_stat=0 then 0 else 1 end),0)  as totalChnlQty_tmp,
				coalesce(sum(case when m1_artrage_usrs=0 or m1_artrage_usrs is null then 0 else 1 end),0) as m1_errChnlQty_tmp,
				coalesce(sum(case when m1_chnl_stat=0 then 0 else 1 end),0) as m1_totalChnlQty_tmp,
				
				trim (errQty_tmp(FORMAT 'ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(15))) as errQty,
				trim (totalQty_tmp(FORMAT 'ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(15))) as totalQty,				
				trim (cast(errQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as errQty_w,
				trim (cast(totalQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as totalQty_w,
				trim ((case when totalQty_tmp=0 then 0 else cast(errQty_tmp as decimal(16,2))*100/totalQty_tmp end ) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as qtyPercent , 
				trim ((case when m1_totalQty_tmp=0 then 0 else cast(m1_errQty_tmp as decimal(16,2))*100/m1_totalQty_tmp end ) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as m1_qtyPercent ,
				
				coalesce(sum(case when artrage_usrs=0 then 0 else 1 end),0) as errChnlQty_tmp,
				coalesce(sum(case when chnl_stat=0 then 0 else 1 end),0)  as totalChnlQty_tmp,
				
				trim (errChnlQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as errChnlQty,
				trim (totalChnlQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as totalChnlQty,	
				trim (cast(errChnlQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as errChnlQty_w,
				trim (cast(totalChnlQty_tmp as decimal(16,2)) (FORMAT 'ZZZ,ZZZ,ZZZ,ZZZ,ZZ9')(VARCHAR(19))) as totalChnlQty_w,
				trim ((case when totalChnlQty_tmp=0 then 0 else cast(errChnlQty_tmp as decimal(16,2))*100/totalChnlQty_tmp end) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as qtyChnlPercent , 
				trim ((case when m1_totalChnlQty_tmp=0 then 0 else cast(m1_errChnlQty_tmp as decimal(16,2))*100/m1_totalChnlQty_tmp end) (FORMAT 'ZZ9.99%')(VARCHAR(7))) as m1_qtyChnlPercent ,
							
				coalesce(sum(m1_artrage_usrs),0) as m1_errQty,		
				coalesce(sum(case when m1_artrage_usrs=0 or m1_artrage_usrs is null then 0 else 1 end),0) as m1_errChnlQty,
				
				(case when (qtyPercent-m1_qtyPercent)>=0 then '上升'  else '下降' end) ||	(trim (case when m1_errQty_tmp=0 then 'N/A' else (cast((qtyPercent-m1_qtyPercent) as decimal(16,2))(FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end))  as abs_fbQtyPercent , 
				(case when (qtyChnlPercent-m1_qtyChnlPercent)>=0 then '上升' else '下降' end)|| (trim (case when m1_errChnlQty_tmp=0 then 'N/A' else (cast((qtyChnlPercent-m1_qtyChnlPercent)as decimal(16,2))(FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end)) as abs_fbChnlPercent	,
				
				trim (case when m1_errQty_tmp=0 then 'N/A' else (cast((m1_errQty_tmp - errQty_tmp) as decimal(16,2))*100/m1_errQty_tmp (FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end)  as fbQtyPercent , 
				trim (case when m1_errChnlQty_tmp=0 then 'N/A' else (cast((m1_errChnlQty_tmp - errChnlQty_tmp)as decimal(16,2))*100/m1_errChnlQty_tmp (FORMAT 'ZZZ,ZZZ,ZZ9.99')(VARCHAR(14))) end) as fbChnlPercent		
								
				from hpbus.Sum_qdyk_2001_compare
				<where> 1=1
					and Aud_trm=#{statCycle}
		<if test="audTrmSTR!=null">
			and Aud_trm IN ${audTrmSTR}
		</if>
		
					<if test="userCityId!=10000">
						and prvd_id = #{userCityId}
					</if>
					<if test="provinceCode!=10000">	
						and prvd_id=#{provinceCode}
					</if>
					and chnl_class='2'
				</where>	
	</select>
	
	
	<resultMap type="java.util.Map"  id="auditReport_ArtrageUserCount">

		<result property="dataBusnArtrageQty" column="dataBusnArtrageQty"/>
		<result property="SpCnsmArtrageQty" column="SpCnsmArtrageQty"/>
		<result property="spamSmsArtrageQty" column="spamSmsArtrageQty"/>
		<result property="crankCallArtrageQty" column="crankCallArtrageQty"/>		
		<result property="groupBusnArtrageQty" column="groupBusnArtrageQty"/>
		<result property="presFeeArtrageQty" column="presFeeArtrageQty"/>

	</resultMap>
	<!-- 按套利模式统计每种套利模式的用户数  -->
	<select id="auditReport_selectArtrageUserCount" resultMap="auditReport_ArtrageUserCount"  parameterType="java.util.Map">
				
		select 
				coalesce(sum(data_busn_artrage_qty),0) as dataBusnArtrageQty_tmp,				
				coalesce(sum(SP_cnsm_artrage_qty),0) as SpCnsmArtrageQty_tmp, 
				coalesce(sum(spam_sms_artrage_qty),0) as spamSmsArtrageQty_tmp,				
				coalesce(sum(crank_call_artrage_qty),0) as crankCallArtrageQty_tmp, 
				coalesce(sum(group_busn_artrage_qty),0) as groupBusnArtrageQty_tmp,				
				coalesce(sum(pres_fee_artrage_qty),0) as presFeeArtrageQty_tmp,
				 
				
				trim (dataBusnArtrageQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as dataBusnArtrageQty,
				trim (SpCnsmArtrageQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as SpCnsmArtrageQty,				
				trim (spamSmsArtrageQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as spamSmsArtrageQty,				
				trim (crankCallArtrageQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as crankCallArtrageQty,				
				trim (groupBusnArtrageQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as groupBusnArtrageQty,				
				trim (presFeeArtrageQty_tmp(FORMAT 'ZZZ,ZZZ,ZZ9')(VARCHAR(11))) as presFeeArtrageQty			
			
				from hpbus.Sum_qdyk_2001
				<where>
					 chnl_stat='1'
					and tol_usrs>0 
					and Aud_trm=#{statCycle}
		<if test="audTrmSTR!=null">
			and Aud_trm IN ${audTrmSTR}
		</if>
		
					<if test="userCityId!=10000">
						and prvd_id = #{userCityId}
					</if>
					<if test="provinceCode!=10000">	
						and prvd_id=#{provinceCode}
					</if>
				</where>	
	</select>
	<!--查询词关注点完成的省份数量-->
	<select id="auditReport_selectFinishedProvinceCount" resultType="int" parameterType="java.util.Map">
		SELECT count(distinct prvd_id) as totalCount
		FROM  hpmgr.busi_model_notify
		<where>
			Aud_trm=#{statCycle}
			 and status=5
			<if test="userCityId!=10000">
				and prvd_id = #{userCityId}
			</if>
			<if test="provinceCode!=10000">	
				and prvd_id=#{provinceCode}
			</if> 
				and Focus_cd='2002' 
		</where>
	</select>
	
	<select id="chnlDetailForRptMonitorOneMonth" resultType="java.util.HashMap" parameterType="java.util.Map">
		select dataReport.*,cityReport.CMCC_prvd_nm_short as cty_name from 
		(
		SELECT
			chnl_id,cty_id,
			max(t.chnl_name) AS chnl_name,
			max(t.chnl_class_nm) AS chnl_class_nm,
			sum(artrage_usrs) as errQty,				
			sum(tol_usrs) as totalQty, 
			case when totalQty=0 then 0 else cast(errQty as decimal(16,2))*100/totalQty end qtyPercent
			from HPBUS.Sum_qdyk_2001 t
		WHERE chnl_stat='1'
		and tol_usrs>0 
		and artrage_usrs>0
		 <if test="params.dateT!=null">
			<![CDATA[and Aud_trm = #{params.dateT}]]>
		</if>
		
		<if test="params.audTrmSTR!=null">
			and Aud_trm IN ${params.audTrmSTR}
		</if>
		
		<if test="params.selProvCodeSTR!=null">
			and t.prvd_id in 
        		${params.selProvCodeSTR}
		</if>
		<if test="params.selCityCodeSTR!=null">
			and t.cty_id in 
        		${params.selCityCodeSTR}
		</if>
		GROUP BY t.chnl_id,cty_id  )  as dataReport
		left join HPMGR.TB_SUM_PRVD_NAME as cityReport
		on dataReport.cty_id = cityReport.CMCC_prvd_cd		
	</select>
	
	<select id="chnlDetailForRptMonitorThreeMonth" resultType="java.util.HashMap"  parameterType="java.util.Map">
		select dataReport.*,cityReport.CMCC_prvd_nm_short as cty_name from 
		(
		SELECT
			chnl_id,cty_id,
			max(t.chnl_name) AS chnl_name,
			max(t.chnl_class_nm) AS chnl_class_nm,
			sum(artrage_usrs) as errQty,				
			sum(tol_usrs) as totalQty, 
			case when totalQty=0 then 0 else cast(errQty as decimal(16,2))*100/totalQty end qtyPercent
			from HPBUS.Sum_qdyk_2001_threeMonth t
		WHERE chnl_stat='1'
		and tol_usrs>0 
		and artrage_usrs>0
		and is_rase = 1
		 <if test="params.dateT!=null">
			<![CDATA[and Aud_trm = #{params.dateT}]]>
		</if>
		
		<if test="params.audTrmSTR!=null">
			and Aud_trm IN ${params.audTrmSTR}
		</if>
		
		<if test="params.selProvCodeSTR!=null">
			and t.prvd_id in 
        		${params.selProvCodeSTR}
		</if>
		<if test="params.selCityCodeSTR!=null">
			and t.cty_id in 
        		${params.selCityCodeSTR}
		</if>
		GROUP BY t.chnl_id,cty_id  )  as dataReport
		left join HPMGR.TB_SUM_PRVD_NAME as cityReport
		on dataReport.cty_id = cityReport.CMCC_prvd_cd		
	</select>
</mapper>

